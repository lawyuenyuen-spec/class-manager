<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å®¤ç®¡ç†å°å¹«æ‰‹ Classroom Manager v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: #222;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 15px;
      color: #555;
    }

    .tab-btn.active {
      background: white;
      font-weight: bold;
      color: #111;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    /* Pages */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Inputs */
    input[type="text"], input[type="number"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
    }

    /* Card */
    .card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .flex {
      display: flex;
      align-items: center;
    }

    .between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .score-num {
      font-size: 24px;
      font-weight: bold;
      margin: 4px 0;
    }

    .plus-btn, .minus-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .plus-btn {
      background: #16a34a;
    }

    .minus-btn {
      background: #dc2626;
    }

    .redeem-btn {
      margin-top: 4px;
      background: #9333ea;
      color: white;
      width: 100%;
      border-radius: 6px;
    }

    /********* Group page *********/
    .group-section {
      display: flex;
      gap: 20px;
    }

    .group-col {
      flex: 1;
    }

    .group-card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    /******** Homework list ********/
    .hw-card {
      padding: 12px;
      border-radius: 12px;
      background: white;
      margin-bottom: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    /******** Homework modal (bubble) ********/
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 900px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .hw-student-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      gap: 8px;
    }

    .hw-student-name {
      min-width: 120px;
    }

    .hw-status-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      min-width: 80px;
    }

    .status-notSubmitted {
      background: #e5e7eb;
      color: #374151;
    }

    .status-submitted {
      background: #bfdbfe;
      color: #1d4ed8;
    }

    .status-toCorrect {
      background: #fed7aa;
      color: #c2410c;
    }

    .status-corrected {
      background: #bbf7d0;
      color: #166534;
    }

    .hw-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .hw-on-time-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 4px;
    }

    .danger-text {
      color: #b91c1c;
      font-size: 13px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>èª²å®¤ç®¡ç†å°å¹«æ‰‹ Classroom Manager v4</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-page="page-individual">å€‹äººè¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-group">å°çµ„è¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-homework">ä½œæ¥­è¨‚æ­£</button>
  </div>

  <!-- ========================= -->
  <!--  PAGE 1: å€‹äººè¨ˆåˆ†é         -->
  <!-- ========================= -->
  <div id="page-individual" class="page active">
    <h2>å€‹äººè¨ˆåˆ†</h2>
    <div id="individualList" class="student-list"></div>

    <hr style="margin:24px 0 16px;">

    <h3>æ–°å¢å­¸ç”Ÿ</h3>
    <div class="card">
      <div style="display:flex; gap:12px; align-items:center;">
        <input id="newSeat" type="number" placeholder="åº§è™Ÿ" style="width:90px;">
        <input id="newName" type="text" placeholder="å§“å">
        <button class="btn-primary" onclick="addStudent()">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!--  PAGE 2: å°çµ„è¨ˆåˆ†é        -->
  <!-- ========================= -->
  <div id="page-group" class="page">

    <h2>å°çµ„è¨ˆåˆ†</h2>

    <!-- æŠ½ç±¤åŠŸèƒ½ -->
    <div class="card" style="margin-bottom:16px;">
      <div class="flex" style="gap:8px;">
        <span>æŠ½ç±¤äººæ•¸ï¼š</span>
        <input id="drawCount" type="number" min="1" style="width:80px;">
        <button class="btn-secondary" onclick="randomDraw()">æŠ½ç±¤</button>
        <span id="drawResult" style="margin-left:8px; font-size:14px; color:#111;"></span>
      </div>
    </div>

    <p style="color:#555;">
      â¤ å·¦é‚Šï¼šæœªåˆ†çµ„å­¸ç”Ÿï¼ˆå¯æ‹–æ›³ï¼‰<br>
      â¤ å³é‚Šï¼šå°çµ„ï¼ˆå¯æ‹–æ›³å­¸ç”Ÿé€²å…¥ï¼‰<br>
      â¤ çµ„å…§ï¼šæŒ‰ + / âˆ’ åŠ ä»Šæ—¥åˆ† â†’ã€Œçµç®—ã€æ™‚ï¼Œå…¨çµ„åŒåˆ†åŠ å…¥å€‹äººç¸½åˆ†<br>
    </p>

    <div class="group-section">

      <!-- å·¦å´ï¼šæœªåˆ†çµ„å­¸ç”Ÿ -->
      <div class="group-col">
        <h3>æœªåˆ†çµ„å­¸ç”Ÿ</h3>

        <div id="ungroupedList" class="student-list">
          <!-- ç”± JS æ¸²æŸ“ -->
        </div>
      </div>

      <!-- å³å´ï¼šå°çµ„åˆ—è¡¨ -->
      <div class="group-col">
        <h3>å°çµ„åˆ—è¡¨</h3>

        <button class="btn-primary" onclick="addGroup()">
          ï¼‹ æ–°å¢å°çµ„
        </button>

        <div id="groupList" style="margin-top:12px;">
          <!-- JS ç”Ÿæˆçµ„å¡ -->
        </div>
      </div>

    </div>

    <hr style="margin:24px 0;">

    <!-- æ’å & å±éšªå€ -->
    <h3>ğŸ† åˆ†çµ„æ’å</h3>
    <div id="groupRanking"></div>

    <h3 style="margin-top:20px;">âš ï¸ å±éšªå€ï¼ˆä»Šæ—¥ 0 åˆ†ï¼‰</h3>
    <div id="dangerZone"></div>

  </div>

  <!-- ========================= -->
  <!--  PAGE 3: ä½œæ¥­è¨‚æ­£é        -->
  <!-- ========================= -->
  <div id="page-homework" class="page">

    <h2>ä½œæ¥­è¨‚æ­£</h2>

    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="newHomeworkTitle" type="text" placeholder="è¼¸å…¥åŠŸèª²åç¨±">
        <button class="btn-primary" onclick="addHomework()">
          ï¼‹ æ–°å¢åŠŸèª²
        </button>
      </div>
      <div style="margin-top:6px; font-size:13px; color:#555;">
        æ¯ä»½åŠŸèª²å¯è¨­å®šï¼š<span class="badge">æœªç¹³äº¤ â†’ å·²ç¹³äº¤ â†’ å¾…è¨‚æ­£ â†’ å·²è¨‚æ­£</span> ï¼Œ
        ä¸¦å¯ç”¨ âœ… æ´¾ã€Œæº–æ™‚äº¤ +1 åˆ†ã€ã€‚
      </div>
    </div>

    <!-- ä½œæ¥­åˆ—è¡¨ -->
    <div id="homeworkList">
      <!-- JS æ¸²æŸ“åŠŸèª²å¡ -->
    </div>

  </div>

</div> <!-- container END -->

<!-- ========================= -->
<!--  Homework Modal (Bubble)  -->
<!-- ========================= -->
<div id="hwModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="hwModalTitle">åŠŸèª²</h3>
      <button class="btn-secondary" onclick="closeHomeworkModal()">é—œé–‰</button>
    </div>

    <div id="hwModalBody">
      <!-- å­¸ç”Ÿåˆ—è¡¨ç”± JS å¡«å…¥ -->
    </div>

    <div class="hw-footer">
      <button class="btn-primary" onclick="applyOnTimeBonusForHomework()">
        ç‚ºå‰”é¸å­¸ç”Ÿ +1 åˆ†
      </button>
    </div>
  </div>
</div>

<!-- ========================= -->
<!--  SCRIPT: æ ¸å¿ƒé‚è¼¯         -->
<!-- ========================= -->
<script>
/* ===========================================================
   ğŸ§   STATEï¼šè³‡æ–™æ¨¡å‹
   =========================================================== */
let state = {
  students: [
    // { id, seat, name, totalScore, individualGroupScoreToday }
  ],
  groups: [
    // { id, name, memberIds: [], groupScore }
  ],
  homeworks: [
    // { id, title, students: { [studentId]: { status, onTimeBonusGiven } } }
  ]
};

const STORAGE_KEY = "class_manager_v4";

/* ä½œæ¥­ç‹€æ…‹ */
const HW_STATES = ["notSubmitted", "submitted", "toCorrect", "corrected"];
const HW_STATE_LABELS = {
  notSubmitted: "æœªç¹³äº¤",
  submitted: "å·²ç¹³äº¤",
  toCorrect: "å¾…è¨‚æ­£",
  corrected: "å·²è¨‚æ­£"
};

/* ===========================================================
   ğŸ’¾  LocalStorageï¼šå„²å­˜ & è¼‰å…¥
   =========================================================== */
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const obj = JSON.parse(saved);
      if (obj && typeof obj === "object") {
        state = obj;
      }
    } catch (e) {
      console.error("State load error:", e);
    }
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ===========================================================
   â• æ–°å¢å­¸ç”Ÿï¼ˆåªåœ¨å€‹äººé é¢ï¼‰
   =========================================================== */
function addStudent() {
  const seat = document.getElementById("newSeat").value.trim();
  const name = document.getElementById("newName").value.trim();

  if (!seat || !name) {
    alert("è«‹è¼¸å…¥åº§è™Ÿèˆ‡å§“å");
    return;
  }

  const id = Date.now();

  state.students.push({
    id,
    seat,
    name,
    totalScore: 0,
    individualGroupScoreToday: 0
  });

  // å°ç¾æœ‰æ‰€æœ‰åŠŸèª²ï¼Œè£œä¸Šé€™ä½å­¸ç”Ÿçš„è¨˜éŒ„
  state.homeworks.forEach(hw => {
    if (!hw.students) hw.students = {};
    hw.students[id] = {
      status: "notSubmitted",
      onTimeBonusGiven: false
    };
  });

  saveState();
  renderIndividualPage();
  renderGroups();
  renderHomeworkList();

  document.getElementById("newSeat").value = "";
  document.getElementById("newName").value = "";
}

/* ===========================================================
   ğŸ§® å€‹äººè¨ˆåˆ†ï¼šåŠ åˆ† / æ‰£åˆ† / å…Œæ›å¡
   =========================================================== */
function changePersonalScore(id, delta) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  stu.totalScore += delta;
  if (stu.totalScore < 0) stu.totalScore = 0;

  saveState();
  renderIndividualPage();
}

function redeemCard(id) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  if (stu.totalScore < 5) {
    alert("åˆ†æ•¸ä¸è¶³ï¼Œä¸èƒ½å…Œæ›å¡ï¼");
    return;
  }

  stu.totalScore -= 5;

  saveState();
  renderIndividualPage();
}

/* ===========================================================
   ğŸ‘¤ å€‹äººè¨ˆåˆ†é ï¼šæ¸²æŸ“
   =========================================================== */
function renderIndividualPage() {
  const container = document.getElementById("individualList");
  if (!container) return;

  container.innerHTML = "";

  const sorted = [...state.students].sort((a, b) => Number(a.seat) - Number(b.seat));

  sorted.forEach(stu => {
    const card = document.createElement("div");
    card.className = "student-card";

    card.innerHTML = `
      <div class="between">
        <strong>${stu.seat}. ${stu.name}</strong>

        <div style="display:flex; gap:6px; align-items:center;">
          <div class="score-num">${stu.totalScore}</div>

          <button class="btn-secondary" style="padding:4px 8px;font-size:12px;"
            onclick="editStudent(${stu.id})">
            ç·¨è¼¯
          </button>

          <button class="btn-danger" style="padding:4px 8px;font-size:12px;"
            onclick="deleteStudent(${stu.id})">
            åˆªé™¤
          </button>
        </div>
      </div>

      <div class="between" style="margin-top:6px;">
        <button class="minus-btn" onclick="changePersonalScore(${stu.id}, -1)">âˆ’</button>
        <button class="plus-btn" onclick="changePersonalScore(${stu.id}, +1)">+</button>
      </div>

      <button class="redeem-btn" onclick="redeemCard(${stu.id})">
        å…Œæ›ä¸€å¼µå¡ï¼ˆ-5åˆ†ï¼‰
      </button>
    `;

    container.appendChild(card);
  });
}

/* ===========================================================
   âœï¸ ç·¨è¼¯å­¸ç”Ÿï¼ˆåº§è™Ÿ + åå­—ï¼‰
   =========================================================== */
function editStudent(id) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  const newSeat = prompt("ä¿®æ”¹åº§è™Ÿï¼š", stu.seat);
  if (newSeat === null) return;

  const newName = prompt("ä¿®æ”¹åå­—ï¼š", stu.name);
  if (newName === null) return;

  stu.seat = newSeat.trim();
  stu.name = newName.trim();

  saveState();

  renderIndividualPage();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸ—‘ï¸ åˆªé™¤å­¸ç”Ÿ
   =========================================================== */
function deleteStudent(id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿï¼Ÿ")) return;

  // åˆªé™¤å­¸ç”Ÿ
  state.students = state.students.filter(s => s.id !== id);

  // å¾æ‰€æœ‰å°çµ„ç§»é™¤
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(sid => sid !== id);
  });

  // å¾æ‰€æœ‰åŠŸèª²ç§»é™¤
  state.homeworks.forEach(hw => {
    if (hw.students && hw.students[id]) {
      delete hw.students[id];
    }
  });

  saveState();

  renderIndividualPage();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
  renderHomeworkList();
}

/* ===========================================================
   ğŸŸ‚ Tabs åˆ‡æ›
   =========================================================== */
function initTabs() {
  const tabs = document.querySelectorAll(".tab-btn");
  const pages = document.querySelectorAll(".page");

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.page;

      tabs.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      pages.forEach(p => {
        p.classList.toggle("active", p.id === target);
      });
    });
  });
}
</script>

<!-- ========================= -->
<!--  SCRIPT: å°çµ„é‚è¼¯         -->
<!-- ========================= -->
<script>
/* ===========================================================
   ğŸŸ¦ æ–°å¢å°çµ„
   =========================================================== */
function addGroup() {
  const id = Date.now();
  state.groups.push({
    id,
    name: "æ–°å°çµ„",
    memberIds: [],
    groupScore: 0
  });
  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ¦ æ¸²æŸ“æ‰€æœ‰å°çµ„ + æœªåˆ†çµ„å­¸ç”Ÿ
   =========================================================== */
function renderGroups() {
  const box = document.getElementById("groupList");
  const ungroupedBox = document.getElementById("ungroupedList");

  if (!box || !ungroupedBox) return;

  box.innerHTML = "";
  ungroupedBox.innerHTML = "";

  // å·¦é‚Šï¼šæœªåˆ†çµ„å­¸ç”Ÿ
  state.students.forEach(stu => {
    const isGrouped = state.groups.some(g => g.memberIds.includes(stu.id));
    if (!isGrouped) {
      const card = makeStudentMiniCard(stu);
      ungroupedBox.appendChild(card);
    }
  });

  // å³é‚Šï¼šå°çµ„åˆ—è¡¨
  state.groups.forEach(group => {
    const card = makeGroupCard(group);
    box.appendChild(card);
  });

  enableDrag();
}

/* ===========================================================
   ğŸŸ¦ æœªåˆ†çµ„å­¸ç”Ÿå°å¡
   =========================================================== */
function makeStudentMiniCard(stu) {
  const div = document.createElement("div");
  div.className = "student-card";
  div.draggable = true;
  div.dataset.sid = stu.id;

  div.innerHTML = `
    <strong>${stu.seat}. ${stu.name}</strong>
    <div style="color:#888;font-size:13px;">æœªåˆ†çµ„</div>
  `;
  return div;
}

/* ===========================================================
   ğŸŸ¦ å°çµ„å¡
   =========================================================== */
function makeGroupCard(group) {
  const div = document.createElement("div");
  div.className = "group-card";
  div.dataset.gid = group.id;

  // è¨ˆç®—çµ„åˆ†ï¼ˆçµ„å…§å€‹äººä»Šæ—¥åˆ†ç›¸åŠ ï¼‰
  group.groupScore = group.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  div.innerHTML = `
    <div class="between">
      <input value="${group.name}" 
             onchange="renameGroup(${group.id}, this.value)"
             style="border:none;font-weight:bold;font-size:16px;">
      <strong>${group.groupScore} åˆ†</strong>
    </div>

    <div class="group-members" style="margin-top:10px;">
      ${renderGroupMembers(group)}
    </div>

    <button class="btn-primary" style="margin-top:10px;"
        onclick="settleGroup(${group.id})">
      çµç®—
    </button>
  `;

  return div;
}

/* ===========================================================
   ğŸŸ¦ çµ„å…§æˆå“¡ + å€‹äººåˆ†æŒ‰éˆ•
   =========================================================== */
function renderGroupMembers(group) {
  let html = "";
  const members = group.memberIds
    .map(id => state.students.find(s => s.id === id))
    .filter(Boolean)
    .sort((a, b) => Number(a.seat) - Number(b.seat));

  members.forEach(stu => {
    if (typeof stu.individualGroupScoreToday !== "number") {
      stu.individualGroupScoreToday = 0;
    }
    html += `
      <div class="between" draggable="true" data-sid="${stu.id}" style="margin-bottom:6px;">
        <span>${stu.seat}. ${stu.name}</span>
        <span>
          <button class="minus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, -1)">âˆ’</button>
          <button class="plus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, +1)">+</button>
        </span>
        <strong>${stu.individualGroupScoreToday}</strong>
      </div>
    `;
  });

  return html;
}

/* ===========================================================
   ğŸŸ¦ ä¿®æ”¹çµ„å
   =========================================================== */
function renameGroup(id, newName) {
  const g = state.groups.find(g => g.id === id);
  if (!g) return;
  g.name = newName.trim();
  saveState();
  renderGroups();
}

/* ===========================================================
   ğŸŸ§ æ‹–æ›³ï¼šå•Ÿç”¨ Drag & Drop
   =========================================================== */
function enableDrag() {
  const draggables = document.querySelectorAll("[draggable='true'][data-sid]");
  const groupCards = document.querySelectorAll(".group-card");

  draggables.forEach(item => {
    item.addEventListener("dragstart", e => {
      e.dataTransfer.setData("sid", e.target.dataset.sid);
    });
  });

  groupCards.forEach(card => {
    card.addEventListener("dragover", e => e.preventDefault());
    card.addEventListener("drop", e => {
      const sid = Number(e.dataTransfer.getData("sid"));
      const gid = Number(card.dataset.gid);
      moveStudentToGroup(sid, gid);
    });
  });

  const ungrouped = document.getElementById("ungroupedList");
  if (!ungrouped) return;
  ungrouped.addEventListener("dragover", e => e.preventDefault());
  ungrouped.addEventListener("drop", e => {
    const sid = Number(e.dataTransfer.getData("sid"));
    removeFromGroup(sid);
  });
}

/* ===========================================================
   ğŸŸ§ ç§»å‹•å­¸ç”Ÿ â†’ å°çµ„
   =========================================================== */
function moveStudentToGroup(sid, gid) {
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });
  const group = state.groups.find(g => g.id === gid);
  if (!group) return;
  group.memberIds.push(sid);

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ§ ç§»é™¤å­¸ç”Ÿ â†’ æœªåˆ†çµ„
   =========================================================== */
function removeFromGroup(sid) {
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });
  const stu = state.students.find(s => s.id === sid);
  if (stu) stu.individualGroupScoreToday = 0;

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ© çµ„å…§å€‹äºº + / âˆ’
   =========================================================== */
function changeGroupMemberScore(sid, delta) {
  const stu = state.students.find(s => s.id === sid);
  if (!stu) return;

  if (typeof stu.individualGroupScoreToday !== "number") {
    stu.individualGroupScoreToday = 0;
  }

  stu.individualGroupScoreToday += delta;
  if (stu.individualGroupScoreToday < 0) stu.individualGroupScoreToday = 0;

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ¥ çµç®—ï¼šçµ„åˆ† â†’ å€‹äººç¸½åˆ†
   =========================================================== */
function settleGroup(gid) {
  const g = state.groups.find(g => g.id === gid);
  if (!g) return;

  const score = g.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  if (score === 0) {
    alert("çµ„åˆ†ç‚º 0ï¼Œä¸èƒ½çµç®—");
    return;
  }

  g.memberIds.forEach(id => {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;
    if (typeof stu.individualGroupScoreToday !== "number") {
      stu.individualGroupScoreToday = 0;
    }
    stu.totalScore += score;
    stu.individualGroupScoreToday = 0;
  });

  g.groupScore = 0;

  saveState();
  renderGroups();
  renderIndividualPage();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   âš ï¸ å±éšªå€ï¼ˆä»Šæ—¥ 0 åˆ†ï¼‰
   =========================================================== */
function renderDangerZone() {
  const box = document.getElementById("dangerZone");
  if (!box) return;
  box.innerHTML = "";

  const zero = state.students.filter(s => (s.individualGroupScoreToday || 0) === 0);

  if (zero.length === 0) {
    box.innerHTML = '<div style="font-size:13px;color:#555;">æš«æ™‚æ²’æœ‰å­¸ç”Ÿåœ¨å±éšªå€ã€‚</div>';
    return;
  }

  zero.forEach(stu => {
    const div = document.createElement("div");
    div.textContent = `${stu.seat}. ${stu.name}ï¼ˆ0 åˆ†ï¼‰`;
    box.appendChild(div);
  });
}

/* ===========================================================
   ğŸ† åˆ†çµ„æ’åï¼ˆæŒ‰ä»Šæ—¥çµ„åˆ†ï¼‰
   =========================================================== */
function renderGroupRanking() {
  const box = document.getElementById("groupRanking");
  if (!box) return;
  box.innerHTML = "";

  if (state.groups.length === 0) {
    box.innerHTML = '<div style="font-size:13px;color:#555;">æš«æ™‚æ²’æœ‰å°çµ„ã€‚</div>';
    return;
  }

  const rank = [...state.groups]
    .map(g => {
      const score = g.memberIds
        .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
        .reduce((a, b) => a + b, 0);
      return { name: g.name, score };
    })
    .sort((a, b) => b.score - a.score);

  rank.forEach((g, i) => {
    const div = document.createElement("div");
    div.textContent = `ç¬¬ ${i + 1} åï¼š${g.name}ï¼ˆ${g.score} åˆ†ï¼‰`;
    box.appendChild(div);
  });
}

/* ===========================================================
   ğŸ² æŠ½ç±¤ï¼ˆå°çµ„é ï¼‰
   =========================================================== */
function randomDraw() {
  const n = Number(document.getElementById("drawCount").value) || 0;
  const candidates = [...state.students];

  if (n <= 0) {
    alert("è«‹è¼¸å…¥è¦æŠ½å‡ºçš„äººæ•¸");
    return;
  }
  if (candidates.length === 0) {
    alert("æš«æ™‚æ²’æœ‰å­¸ç”Ÿåå–®");
    return;
  }

  const shuffled = candidates.sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, Math.min(n, candidates.length));

  const box = document.getElementById("drawResult");
  box.textContent = selected.map(s => `${s.seat}. ${s.name}`).join("ã€");
}
</script>

<!-- ========================= -->
<!--  SCRIPT: ä½œæ¥­é‚è¼¯         -->
<!-- ========================= -->
<script>
let currentHomeworkId = null;

/* ===========================================================
   â• æ–°å¢åŠŸèª²
   =========================================================== */
function addHomework() {
  const input = document.getElementById("newHomeworkTitle");
  const title = input.value.trim();
  if (!title) {
    alert("è«‹è¼¸å…¥åŠŸèª²åç¨±");
    return;
  }

  const id = Date.now();
  const hw = {
    id,
    title,
    students: {}
  };

  // åˆå§‹åŒ–æ¯ä½å­¸ç”Ÿçš„ç‹€æ…‹
  state.students.forEach(stu => {
    hw.students[stu.id] = {
      status: "notSubmitted",
      onTimeBonusGiven: false
    };
  });

  state.homeworks.push(hw);
  saveState();
  renderHomeworkList();
  input.value = "";
}

/* ===========================================================
   ğŸ—‘ï¸ åˆªé™¤åŠŸèª²
   =========================================================== */
function deleteHomework(id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½åŠŸèª²ï¼Ÿ")) return;
  state.homeworks = state.homeworks.filter(h => h.id !== id);
  saveState();
  renderHomeworkList();
  if (currentHomeworkId === id) {
    closeHomeworkModal();
  }
}

/* ===========================================================
   ğŸ“‹ æ¸²æŸ“åŠŸèª²åˆ—è¡¨
   =========================================================== */
function renderHomeworkList() {
  const list = document.getElementById("homeworkList");
  if (!list) return;

  list.innerHTML = "";

  if (state.homeworks.length === 0) {
    list.innerHTML = '<div class="hw-card" style="color:#777;">æš«æ™‚æœªæœ‰åŠŸèª²ï¼Œè«‹å…ˆæ–°å¢ã€‚</div>';
    return;
  }

  state.homeworks.forEach(hw => {
    const card = document.createElement("div");
    card.className = "hw-card";

    const studentCount = state.students.length;
    let submittedCount = 0;
    if (hw.students) {
      submittedCount = Object.values(hw.students).filter(s => s.status !== "notSubmitted").length;
    }

    card.innerHTML = `
      <div class="between">
        <div>
          <strong>${hw.title}</strong>
          <span class="badge">${submittedCount}/${studentCount} å·²äº¤æˆ–è¨‚æ­£ä¸­</span>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn-secondary" onclick="openHomeworkModal(${hw.id})">
            ç®¡ç†
          </button>
          <button class="btn-danger" onclick="deleteHomework(${hw.id})">
            åˆªé™¤
          </button>
        </div>
      </div>
    `;

    list.appendChild(card);
  });
}

/* ===========================================================
   ğŸ”µ æ‰“é–‹åŠŸèª² Bubble
   =========================================================== */
function openHomeworkModal(id) {
  currentHomeworkId = id;
  const overlay = document.getElementById("hwModal");
  overlay.classList.add("active");
  renderHomeworkModal();
}

/* ===========================================================
   ğŸ”´ é—œé–‰ Bubble
   =========================================================== */
function closeHomeworkModal() {
  currentHomeworkId = null;
  document.getElementById("hwModal").classList.remove("active");
}

/* ===========================================================
   æ¸²æŸ“ Bubble å…§å­¸ç”Ÿåˆ—è¡¨
   =========================================================== */
function renderHomeworkModal() {
  const hw = state.homeworks.find(h => h.id === currentHomeworkId);
  const titleEl = document.getElementById("hwModalTitle");
  const body = document.getElementById("hwModalBody");
  if (!hw || !titleEl || !body) return;

  if (!hw.students) hw.students = {};

  titleEl.textContent = hw.title;
  body.innerHTML = "";

  const sorted = [...state.students].sort((a, b) => Number(a.seat) - Number(b.seat));

  sorted.forEach(stu => {
    if (!hw.students[stu.id]) {
      hw.students[stu.id] = {
        status: "notSubmitted",
        onTimeBonusGiven: false
      };
    }
    const data = hw.students[stu.id];

    const row = document.createElement("div");
    row.className = "hw-student-row";

    row.innerHTML = `
      <div class="hw-student-name">${stu.seat}. ${stu.name}</div>

      <button class="hw-status-btn status-${data.status}"
        onclick="cycleHomeworkStatus(${stu.id})">
        ${HW_STATE_LABELS[data.status] || "æœªç¹³äº¤"}
      </button>

      <label class="hw-on-time-label">
        <input type="checkbox" class="hw-on-time" data-sid="${stu.id}"
          ${data.onTimeBonusGiven ? "disabled" : ""}>
        <span>${data.onTimeBonusGiven ? "å·²åŠ åˆ†" : "æº–æ™‚äº¤"}</span>
      </label>
    `;

    body.appendChild(row);
  });

  saveState(); // è‹¥è£œäº†å­¸ç”Ÿè¨˜éŒ„ï¼Œé †ä¾¿å­˜ä¸€æ¬¡
}

/* ===========================================================
   è®Šæ›´å­¸ç”Ÿä½œæ¥­ç‹€æ…‹ï¼ˆå¾ªç’°ï¼‰
   =========================================================== */
function cycleHomeworkStatus(studentId) {
  const hw = state.homeworks.find(h => h.id === currentHomeworkId);
  if (!hw || !hw.students || !hw.students[studentId]) return;

  const cur = hw.students[studentId].status || "notSubmitted";
  const idx = HW_STATES.indexOf(cur);
  const next = HW_STATES[(idx + 1) % HW_STATES.length];

  hw.students[studentId].status = next;

  saveState();
  renderHomeworkModal();
}

/* ===========================================================
   ç‚ºå‰”é¸å­¸ç”Ÿæ´¾ã€Œæº–æ™‚äº¤ +1 åˆ†ã€
   =========================================================== */
function applyOnTimeBonusForHomework() {
  const hw = state.homeworks.find(h => h.id === currentHomeworkId);
  if (!hw || !hw.students) return;

  const overlay = document.getElementById("hwModal");
  const checkboxes = overlay.querySelectorAll("input.hw-on-time:checked");

  let addedCount = 0;

  checkboxes.forEach(cb => {
    const sid = Number(cb.dataset.sid);
    const entry = hw.students[sid];
    if (!entry || entry.onTimeBonusGiven) return;

    const stu = state.students.find(s => s.id === sid);
    if (!stu) return;

    // çœŸæ­£åŠ åˆ†ï¼šåªæœƒåŠ ä¸€æ¬¡
    stu.totalScore += 1;
    entry.onTimeBonusGiven = true;
    addedCount += 1;
  });

  if (addedCount === 0) {
    alert("æ²’æœ‰æ–°çš„åŒå­¸ç²å¾—çå‹µï¼ˆå¯èƒ½ä¹‹å‰å·²åŠ éåˆ†ï¼‰ã€‚");
  } else {
    alert(`å·²ç‚º ${addedCount} ä½åŒå­¸åŠ  1 åˆ†ã€‚`);
  }

  saveState();
  renderIndividualPage();
  renderHomeworkModal(); // é‡æ–°æ¸²æŸ“ï¼Œæ›´æ–°ã€Œå·²åŠ åˆ†ã€ç‹€æ…‹
}
</script>

<!-- ========================= -->
<!--  INIT                     -->
<!-- ========================= -->
<script>
loadState();

document.addEventListener("DOMContentLoaded", () => {
  initTabs();
  renderIndividualPage();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
  renderHomeworkList();
});
</script>

</body>
</html>
