<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å®¤ç®¡ç†å°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æŸ”å’Œå­—é«”ï¼šNunito + Noto Sans TC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Nunito", "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: #222;
      font-weight: 700;
    }

    h2 { margin-top: 0; }

    /* ç™»å…¥åˆ— */
    .auth-bar {
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      font-size:13px;
      color:#555;
    }
    .auth-bar strong { color:#111; }

    /* Tabs */
    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 15px;
      color: #555;
    }

    .tab-btn.active {
      background: white;
      font-weight: bold;
      color: #111;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .page { display: none; }
    .page.active { display: block; }

    input[type="text"], input[type="number"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-danger  { background: #dc2626; color: white; }
    .btn-secondary { background: #e5e7eb; }

    .card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      font-size: 14px;
    }

    .score-num {
      font-size: 22px;
      font-weight: 700;
      margin: 0 6px;
    }

    .plus-btn, .minus-btn {
      display:flex;
      justify-content:center;
      align-items:center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 22px;
      font-weight: bold;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .plus-btn { background:#16a34a; }
    .minus-btn { background:#dc2626; }

    .edit-btn   { font-size: 20px; cursor: pointer; margin-right: 4px; }
    .delete-btn { font-size: 20px; cursor: pointer; color: #dc2626; }

    /* Group page */
    .group-card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    /* å°çµ„åˆ—è¡¨ï¼šé è¨­æ‰‹æ©Ÿï¼ç´°è¢å¹• 1ï½2 æ¬„ */
.group-list-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
  margin-top: 10px;
}

/* âœ… iPad æ©«å‘ / é›»è…¦ï¼šå›ºå®šä¸‰æ¬„ */
@media (min-width: 1024px) {
  .group-list-grid {
    grid-template-columns: repeat(3, 1fr);  /* ä¸€è¡Œ 3 å€‹å°çµ„ */
    gap: 8px;
  }
}

    /* å°çµ„å­¸ç”Ÿï¼šå…©å€‹ä¸€è¡Œ */
    .group-members-grid {
      margin-top: 10px;
    }

    .group-members-row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 8px;
    }

   .group-member-card {
  flex: 1;
  min-height: 56px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  font-size: 16px;
}

.group-member-name {
  font-size: 18px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-right: 4px;
}

.group-member-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.group-member-controls .minus-btn,
.group-member-controls .plus-btn {
  width: 32px;
  height: 32px;
  font-size: 20px;
}

.group-member-score {
  width: 32px;
  text-align: center;
  font-size: 18px;
  font-weight: 800;
}

    /* åˆ†çµ„æ’åï¼‹å±éšªå€ï¼‹æŠ½ç±¤ ä¸‰æ¬„ */
    .row-lotteryDanger {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .row-lotteryDanger > div {
      flex: 1 1 0;
      min-width: 240px;
    }

    /* Homework */
    .hw-card {
      padding: 12px;
      border-radius: 12px;
      background: white;
      margin-bottom: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    /* Homework Modal */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal {
      background: white;
      width: 95%;
      max-width: 1100px;
      padding: 24px;
      border-radius: 18px;
      max-height: 88vh;
      overflow-y: auto;
    }

    .student-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .hw-stu-card {
      padding: 14px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #ddd;
      font-size: 15px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .hw-left {
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }

    .hw-name {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .circle-check {
      width: 24px;
      height: 24px;
      border: 2px solid #9ca3af;
      border-radius: 50%;
      cursor: pointer;
      flex-shrink:0;
      background: transparent;
    }

    .circle-check.checked {
      background: #2563eb;
      border-color: #2563eb;
    }

    .circle-check.awarded {
      background: #16a34a;
      border-color: #16a34a;
      cursor: default;
    }

    .status-btn {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      white-space: nowrap;
    }

    .status-btn.status-æœªç¹³äº¤ { background: #d1d5db; color: #444; }
    .status-btn.status-å·²ç¹³äº¤ { background: #3b82f6; color: white; }
    .status-btn.status-å¾…è¨‚æ­£ { background: #f97316; color: white; }
    .status-btn.status-å·²è¨‚æ­£ { background: #16a34a; color: white; }

    .modal-footer {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .student-grid {
        grid-template-columns: 1fr;
      }
      .row-lotteryDanger {
        flex-direction: column;
      }
      .group-list-grid {
        grid-template-columns: 1fr;
      }
      .group-member-card {
        flex: 1 1 100%;
      }
    }

    /* æŠ½å¡å€ï¼šå¡ç‰‡æ’åˆ— */
    .reward-card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .reward-card {
      flex: 1 1 calc(33.33% - 10px);
      min-width: 150px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      line-height: 1.4;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .reward-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .reward-card.mystery {
      background: #e0f2fe;
      border-style: dashed;
    }

    .reward-card.selected {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.3);
      background: #eff6ff;
    }
    
/* å°çµ„åˆ—è¡¨ï¼šé è¨­æ‰‹æ©Ÿï¼ç´°è¢å¹• 1ï½2 æ¬„ */
.group-list-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
  margin-top: 10px;
}

@media (min-width: 1024px) {
  /* âœ… ä¸€è¡Œ 3 å€‹å°çµ„ */
  .group-list-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  /* æ•´é«” group å¡å†è–„å°‘å°‘ */
  .group-card {
    padding: 8px;
    margin-bottom: 6px;
  }
}
    
    /* âœ… å°çµ„æ‘ºç–Šæ¨¡å¼ï¼šåªé¡¯ç¤ºçµ„åï¼‹åˆ†æ•¸ */
.group-card.collapsed {
  padding: 6px 10px;
}

/* æ‘ºç–Šæ™‚ï¼šéš±è—çµ„å“¡åˆ—è¡¨ + çµç®—æŒ‰éˆ• */
.group-card.collapsed .group-members-grid,
.group-card.collapsed .group-settle-btn {
  display: none;
}

/* çµ„ååˆ—å¯ä»¥é»æ“Š */
.group-header {
  cursor: pointer;
}
    
  </style>
</head>

<body>
<div class="container">

  <h1>èª²å®¤ç®¡ç†å°å¹«æ‰‹</h1>

  <!-- ç™»å…¥åˆ— -->
  <div class="auth-bar">
    <span id="userInfo">æœªç™»å…¥ï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰</span>
    <button id="syncBtn" class="btn-secondary">ğŸ”„ ç«‹å³åŒæ­¥</button>
    <button id="loginBtn" class="btn-secondary">ç”¨ Google ç™»å…¥</button>
    <button id="logoutBtn" class="btn-secondary" style="display:none;">ç™»å‡º</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-page="page-individual">å€‹äººç©åˆ†</button>
    <button class="tab-btn" data-page="page-group">å°çµ„ç©åˆ†</button>
    <button class="tab-btn" data-page="page-homework">ä½œæ¥­è¨‚æ­£</button>
  </div>

  <!-- å€‹äººç©åˆ†é  -->
  <div id="page-individual" class="page active">
    <h2>å€‹äººç©åˆ†</h2>
    <div id="individualList" class="student-list"></div>

    <hr style="margin:24px 0 12px;">
    <h2>æ–°å¢å­¸ç”Ÿ</h2>
    <div class="card">
      <input id="newSeat" type="number" placeholder="åº§è™Ÿ" style="width:90px;">
      <input id="newName" type="text" placeholder="å§“å" style="margin-left:8px;margin-right:8px;">
      <button class="btn-primary" onclick="addStudent()">æ–°å¢</button>
    </div>
  </div>

  <!-- å°çµ„ç©åˆ†é  -->
  <div id="page-group" class="page">
    <h2>å°çµ„ç©åˆ†</h2>

    <!-- æ–°å¢å°çµ„æŒ‰éˆ• -->
    <div class="card" style="margin-bottom:16px;">
      <button class="btn-primary" onclick="addGroup()">ï¼‹ æ–°å°çµ„</button>
    </div>

    <!-- å°çµ„åˆ—è¡¨ï¼šå…©æ¬„ä¸¦æ’ -->
    <div>
      <h3>å°çµ„åˆ—è¡¨</h3>
      <div id="groupList" class="group-list-grid"></div>
    </div>

    <hr style="margin:24px 0 12px;">

    <!-- æœªåˆ†çµ„å­¸ç”Ÿ æ”¾åœ¨ä¸‹é¢ -->
    <h3>æœªåˆ†çµ„å­¸ç”Ÿ</h3>
    <div id="ungroupedList" class="student-list"></div>

    <hr style="margin:24px 0 12px;">

    <!-- åˆ†çµ„æ’å + å±éšªå€ + æŠ½ç±¤ åŒä¸€è¡Œ -->
    <div class="row-lotteryDanger">
      <div>
        <h3>ğŸ† åˆ†çµ„æ’å</h3>
        <div id="groupRanking"></div>
      </div>

      <div>
        <h3>âš ï¸ å±éšªå€ï¼ˆä»Šæ—¥ 0 åˆ†ï¼‰</h3>
        <div id="dangerZone"></div>
      </div>

      <div class="card">
        <h3>ğŸ¯ æŠ½ç±¤</h3>
        <input id="lotteryNum" type="number" placeholder="æŠ½å‡ºäººæ•¸" style="width:120px;">
        <button class="btn-primary" onclick="drawLottery()">æŠ½ç±¤</button>
        <div id="lotteryResult" style="margin-top:10px; font-size:16px; font-weight:600;"></div>
      </div>
    </div>

    <!-- ğŸ´ æŠ½å¡å€ï¼ˆåªåœ¨å°çµ„é é¡¯ç¤ºï¼‰ -->
    <div class="card" style="margin-top:16px;">
      <h3>ğŸ´ æŠ½å¡å€</h3>

      <div id="cardList" class="reward-card-grid"></div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn-secondary" onclick="showAllCards()">ğŸ‘€ é¡¯ç¤ºæ‰€æœ‰å¡</button>
        <button class="btn-secondary" onclick="resetCards()">ğŸ” é‡æ–°æ´—ç‰Œ</button>
      </div>

      <div id="cardHint" style="margin-top:8px; font-size:13px; color:#555;">
        æ­¥é©Ÿï¼šè«‹åŒå­¸å…ˆæ€ä¸€å¼µç¥ç§˜å¡ â†’ é¡¯ç¤ºæ•ˆæœã€‚
      </div>
    </div>
  </div>
  <!-- å°çµ„é å®Œ -->

  <!-- ä½œæ¥­è¨‚æ­£é  -->
  <div id="page-homework" class="page">
    <h2>ä½œæ¥­è¨‚æ­£</h2>

    <div style="margin-bottom:12px;">
      <input id="newHomeworkTitle" type="text" placeholder="è¼¸å…¥åŠŸèª²åç¨±">
      <button class="btn-primary" onclick="addHomework()">ï¼‹ æ–°å¢åŠŸèª²</button>
    </div>

    <div id="homeworkList"></div>
  </div>

</div>

<!-- ä½œæ¥­å¤§è¦–çª— Modal -->
<div id="hwModalBG" class="modal-bg">
  <div class="modal">
    <h2 id="hwModalTitle"></h2>
    <div id="hwModalList" class="student-grid"></div>

    <div class="modal-footer">
      <button class="btn-danger" onclick="deleteHomework()">ğŸ—‘ åˆªé™¤åŠŸèª²</button>
      <button class="btn-primary" onclick="awardOnTime()">æº–æ™‚äº¤ +1 åˆ†</button>
      <button class="btn-secondary" onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- ä¸»ç¨‹å¼ï¼šFirebase + App é‚è¼¯ -->
<script type="module">
  /* ================= Firebase åˆå§‹åŒ– ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { 
    getAuth, 
    GoogleAuthProvider, 
    signInWithPopup, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXq6GUpNLZGUt5OR9JUGnEyHww0W5141k",
    authDomain: "class-manage-a78af.firebaseapp.com",
    projectId: "class-manage-a78af",
    storageBucket: "class-manage-a78af.firebasestorage.app",
    messagingSenderId: "864798135082",
    appId: "1:864798135082:web:362938e75a24151e188453",
    measurementId: "G-DB5JV1ZDBT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  let currentUser = null;

  /* ================= STATE & STORAGE ================= */
  let state = {
    students: [],
    groups: [],
    homeworks: []
  };

  const STORAGE_KEY = "class_manager_v6";

  function loadStateLocal() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try { state = JSON.parse(saved); }
      catch (e) { console.error("è§£ææœ¬æ©Ÿè³‡æ–™å¤±æ•—", e); }
    }
  }

  function saveStateLocal() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  async function loadStateFromCloud() {
    if (!db || !currentUser) return;
    try {
      const ref = doc(db, "users", currentUser.uid, "classes", "default");
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        if (data && data.state) {
          state = data.state;
          saveStateLocal();
          console.log("â˜ï¸ å·²ç”±é›²ç«¯è¦†è“‹ state");
        }
      } else {
        await setDoc(ref, { state }, { merge: true });
        console.log("â˜ï¸ é›²ç«¯é¦–æ¬¡å»ºç«‹ state");
      }
    } catch (e) {
      console.error("å¾é›²ç«¯è¼‰å…¥å¤±æ•—", e);
    }
  }

  async function saveStateToCloud() {
    if (!db || !currentUser) return;
    try {
      const ref = doc(db, "users", currentUser.uid, "classes", "default");
      await setDoc(ref, { state }, { merge: true });
      console.log("â˜ï¸ å·²å„²å­˜ state åˆ°é›²ç«¯");
    } catch (e) {
      console.error("å„²å­˜åˆ°é›²ç«¯å¤±æ•—", e);
    }
  }

  function saveState() {
    saveStateLocal();
    saveStateToCloud();
  }

  function rerenderAll() {
    renderIndividual();
    renderGroups();
    renderGroupRanking();
    renderDangerZone();
    renderHomeworkList();
    renderCards();   // æŠ½å¡å€éƒ½é‡ç•«ä¸€æ¬¡
  }

  /* ================= Tabs ================= */
  function initTabs() {
    const tabs = document.querySelectorAll(".tab-btn");
    const pages = document.querySelectorAll(".page");

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.page;
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        pages.forEach(p => p.classList.toggle("active", p.id === target));
      });
    });
  }

  /* ================= ç™»å…¥ UI + åŒæ­¥ ================= */
  function initAuthUI() {
    const userInfo = document.getElementById("userInfo");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const syncBtn = document.getElementById("syncBtn");

    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("ç™»å…¥å¤±æ•—ï¼š" + (err.message || err));
      }
    };

    logoutBtn.onclick = async () => {
      try {
        await signOut(auth);
      } catch (err) {
        alert("ç™»å‡ºå¤±æ•—ï¼š" + (err.message || err));
      }
    };

    syncBtn.onclick = async () => {
      if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥ Googleï¼Œæ‰å¯ä»¥å¾é›²ç«¯åŒæ­¥ã€‚");
        return;
      }
      await loadStateFromCloud();
      rerenderAll();
      alert("å·²ç”±é›²ç«¯é‡æ–°è¼‰å…¥æœ€æ–°è³‡æ–™ã€‚");
    };

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        userInfo.innerHTML = `å·²ç™»å…¥ï¼š<strong>${user.displayName || user.email}</strong>`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        await loadStateFromCloud();
        rerenderAll();
      } else {
        userInfo.textContent = "æœªç™»å…¥ï¼ˆä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼‰";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    });
  }

  /* ================= å€‹äººç©åˆ† ================= */
  function addStudent() {
    const seatInput = document.getElementById("newSeat");
    const nameInput = document.getElementById("newName");
    const seat = seatInput.value.trim();
    const name = nameInput.value.trim();
    if (!seat || !name) {
      alert("è«‹è¼¸å…¥åº§è™Ÿèˆ‡å§“å");
      return;
    }

    const id = Date.now();

    state.students.push({
      id,
      seat: Number(seat),
      name,
      totalScore: 0,
      individualGroupScoreToday: 0
    });

    state.homeworks.forEach(hw => {
      hw.status[id] = "æœªç¹³äº¤";
    });

    saveState();
    rerenderAll();

    seatInput.value = "";
    nameInput.value = "";
  }

  function changePersonalScore(id, delta) {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;
    stu.totalScore = Math.max(0, stu.totalScore + delta);
    saveState();
    renderIndividual();
  }

  function redeemCard(id) {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;
    if (stu.totalScore < 5) {
      alert("ä¸è¶³ 5 åˆ†ï¼Œä¸èƒ½å…Œæ›ï¼");
      return;
    }
    stu.totalScore -= 5;
    saveState();
    renderIndividual();
  }

  function editStudent(id) {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;

    const newSeat = prompt("ä¿®æ”¹åº§è™Ÿï¼š", stu.seat);
    if (newSeat === null) return;
    const newName = prompt("ä¿®æ”¹åå­—ï¼š", stu.name);
    if (newName === null) return;

    stu.seat = Number(newSeat.trim());
    stu.name = newName.trim();

    saveState();
    rerenderAll();
  }

  function deleteStudent(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿï¼Ÿ")) return;

    state.students = state.students.filter(s => s.id !== id);
    state.groups.forEach(g => {
      g.memberIds = g.memberIds.filter(sid => sid !== id);
    });
    state.homeworks.forEach(hw => {
      delete hw.status[id];
      hw.awarded = hw.awarded.filter(x => x !== id);
    });

    saveState();
    rerenderAll();
  }

  function renderIndividual() {
    const box = document.getElementById("individualList");
    if (!box) return;
    box.innerHTML = "";

    const sorted = [...state.students].sort((a,b) => a.seat - b.seat);

    sorted.forEach(stu => {
      const div = document.createElement("div");
      div.className = "student-card";

      div.innerHTML = `
        <div class="between">
          <strong>${stu.seat}. ${stu.name}</strong>
          <div style="display:flex;align-items:center;">
            <span class="edit-btn" onclick="editStudent(${stu.id})">âœï¸</span>
            <span class="delete-btn" onclick="deleteStudent(${stu.id})">âŒ</span>
          </div>
        </div>

        <div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:6px;">
          <button class="minus-btn" onclick="changePersonalScore(${stu.id}, -1)">âˆ’</button>
          <span class="score-num">${stu.totalScore}</span>
          <button class="plus-btn" onclick="changePersonalScore(${stu.id}, 1)">ï¼‹</button>
        </div>

        <button class="btn-primary" style="margin-top:6px;width:100%;border-radius:8px;"
          onclick="redeemCard(${stu.id})">
          å…Œæ›ä¸€å¼µå¡ï¼ˆ-5 åˆ†ï¼‰
        </button>
      `;

      box.appendChild(div);
    });
  }

  /* ================= å°çµ„ç©åˆ† ================= */
  function addGroup() {
  state.groups.push({
    id: Date.now(),
    name: "æ–°å¢å°çµ„",
    memberIds: [],
    groupScore: 0,
    collapsed: false   // âœ… æ–°å¢ï¼šé è¨­å””æ‘ºç–Š
  });
  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

  function deleteGroup(gid) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å°çµ„ï¼Ÿ")) return;

    const g = state.groups.find(x => x.id === gid);
    if (!g) return;

    g.memberIds.forEach(sid => {
      const stu = state.students.find(s => s.id === sid);
      if (stu) stu.individualGroupScoreToday = 0;
    });

    state.groups = state.groups.filter(x => x.id !== gid);

    saveState();
    renderGroups();
    renderGroupRanking();
    renderDangerZone();
  }

  function renderGroups() {
    const groupBox = document.getElementById("groupList");
    const ungroupedBox = document.getElementById("ungroupedList");
    if (!groupBox || !ungroupedBox) return;

    groupBox.innerHTML = "";
    ungroupedBox.innerHTML = "";

    // æœªåˆ†çµ„å­¸ç”Ÿ
    state.students.forEach(stu => {
      const inGroup = state.groups.some(g => g.memberIds.includes(stu.id));
      if (!inGroup) {
        const card = document.createElement("div");
        card.className = "student-card";
        card.draggable = true;
        card.dataset.sid = stu.id;
        card.innerHTML = `<strong>${stu.seat}. ${stu.name}</strong>`;
        ungroupedBox.appendChild(card);
      }
    });

    // å°çµ„
    state.groups.forEach(g => {
    const div = document.createElement("div");
    const collapsedClass = g.collapsed ? " collapsed" : "";
    div.className = "group-card" + collapsedClass;
    div.dataset.gid = g.id;

      g.groupScore = g.memberIds
        .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
        .reduce((a, b) => a + b, 0);

      let members = g.memberIds
        .map(id => state.students.find(s => s.id === id))
        .filter(Boolean)
        .sort((a,b) => a.seat - b.seat);

      let membersHTML = "";
      for (let i = 0; i < members.length; i += 2) {
        const m1 = members[i];
        const m2 = members[i + 1];
        membersHTML += `
          <div class="group-members-row">
            ${renderMemberCard(m1)}
            ${m2 ? renderMemberCard(m2) : ""}
          </div>
        `;
      }

      div.innerHTML = `
  <div class="between group-header" onclick="toggleGroupCollapse(${g.id})">
    <input value="${g.name}"
      onchange="renameGroup(${g.id}, this.value)"
      onclick="event.stopPropagation();"
      style="border:none;font-size:16px;font-weight:bold;">

    <div style="display:flex;align-items:center;gap:10px;">
      <strong>${g.groupScore} åˆ†</strong>
      <span style="cursor:pointer;font-size:20px;color:#dc2626;"
        onclick="deleteGroup(${g.id}); event.stopPropagation();">
        ğŸ—‘
      </span>
    </div>
  </div>

  <div class="group-members-grid">
    ${membersHTML}
  </div>

  <button class="btn-primary group-settle-btn" style="margin-top:8px;" onclick="settleGroup(${g.id})">
    çµç®—
  </button>
`;

      groupBox.appendChild(div);
    });

    enableDrag();
  }

  function renameGroup(id, name) {
    const g = state.groups.find(x => x.id === id);
    if (!g) return;
    g.name = name.trim();
    saveState();
  }

  function renderMemberCard(stu) {
    if (!stu) return "";
    return `
      <div class="group-member-card" draggable="true" data-sid="${stu.id}">
        <div class="group-member-name">${stu.seat}. ${stu.name}</div>

        <div class="group-member-controls">
          <button class="minus-btn"
            onclick="changeGroupMemberScore(${stu.id}, -1); event.stopPropagation();">âˆ’</button>

          <span class="group-member-score">${stu.individualGroupScoreToday}</span>

          <button class="plus-btn"
            onclick="changeGroupMemberScore(${stu.id}, 1); event.stopPropagation();">ï¼‹</button>
        </div>
      </div>
    `;
  }

  function enableDrag() {
    const draggables = document.querySelectorAll("[draggable='true'][data-sid]");
    const groupCards = document.querySelectorAll(".group-card");
    const ungrouped = document.getElementById("ungroupedList");

    draggables.forEach(el => {
      el.addEventListener("dragstart", e => {
        e.dataTransfer.setData("sid", el.dataset.sid);
      });
    });

    groupCards.forEach(card => {
      card.addEventListener("dragover", e => e.preventDefault());
      card.addEventListener("drop", e => {
        e.preventDefault();
        const sid = Number(e.dataTransfer.getData("sid"));
        const gid = Number(card.dataset.gid);
        moveStudentToGroup(sid, gid);
      });
    });

    if (ungrouped) {
      ungrouped.addEventListener("dragover", e => e.preventDefault());
      ungrouped.addEventListener("drop", e => {
        e.preventDefault();
        const sid = Number(e.dataTransfer.getData("sid"));
        removeFromGroup(sid);
      });
    }
  }

  function moveStudentToGroup(sid, gid) {
    state.groups.forEach(g => {
      g.memberIds = g.memberIds.filter(x => x !== sid);
    });

    const target = state.groups.find(g => g.id === gid);
    if (!target) return;
    target.memberIds.push(sid);

    saveState();
    renderGroups();
    renderGroupRanking();
    renderDangerZone();
  }

  function removeFromGroup(sid) {
    state.groups.forEach(g => {
      g.memberIds = g.memberIds.filter(x => x !== sid);
    });

    const stu = state.students.find(s => s.id === sid);
    if (stu) stu.individualGroupScoreToday = 0;

    saveState();
    renderGroups();
    renderGroupRanking();
    renderDangerZone();
  }

  function changeGroupMemberScore(id, delta) {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;
    stu.individualGroupScoreToday = Math.max(0, stu.individualGroupScoreToday + delta);
    saveState();
    renderGroups();
    renderGroupRanking();
    renderDangerZone();
  }

  function settleGroup(gid) {
    const g = state.groups.find(x => x.id === gid);
    if (!g) return;
    const score = g.memberIds
      .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
      .reduce((a,b) => a + b, 0);
    if (score === 0) {
      alert("çµ„åˆ†ç‚º 0ï¼Œä¸èƒ½çµç®—");
      return;
    }

    g.memberIds.forEach(id => {
      const stu = state.students.find(s => s.id === id);
      if (!stu) return;
      stu.totalScore += score;
      stu.individualGroupScoreToday = 0;
    });

    saveState();
    renderGroups();
    renderIndividual();
    renderDangerZone();
  }
  
function toggleGroupCollapse(gid) {
  const g = state.groups.find(x => x.id === gid);
  if (!g) return;
  g.collapsed = !g.collapsed;
  saveState();
  renderGroups();   // â­ é‡æ–°ç•«
}
  /* åˆ†çµ„æ’å */
  function renderGroupRanking() {
    const box = document.getElementById("groupRanking");
    if (!box) return;
    box.innerHTML = "";

    const rank = state.groups.map(g => {
      const score = g.memberIds
        .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
        .reduce((a,b) => a + b, 0);
      return { name: g.name, score };
    }).sort((a,b) => b.score - a.score);

    rank.forEach((g,i) => {
      const div = document.createElement("div");
      div.textContent = `ç¬¬ ${i+1} åï¼š${g.name}ï¼ˆ${g.score} åˆ†ï¼‰`;
      box.appendChild(div);
    });
  }

  /* å±éšªå€ï¼šä»Šæ—¥ 0 åˆ† */
  function renderDangerZone() {
    const box = document.getElementById("dangerZone");
    if (!box) return;
    box.innerHTML = "";

    const zero = state.students.filter(s => s.individualGroupScoreToday === 0);
    if (zero.length === 0) {
      box.textContent = "æš«æ™‚æ²’æœ‰äººåœ¨å±éšªå€ ğŸ‘";
      return;
    }

    zero.forEach(stu => {
      const div = document.createElement("div");
      div.textContent = `${stu.seat}. ${stu.name}ï¼ˆ0 åˆ†ï¼‰`;
      box.appendChild(div);
    });
  }

  /* æŠ½ç±¤ */
  function drawLottery() {
    const numInput = document.getElementById("lotteryNum");
    const out = document.getElementById("lotteryResult");
    const n = Number(numInput.value);
    if (!n || n <= 0) {
      alert("è«‹è¼¸å…¥æŠ½å‡ºäººæ•¸");
      return;
    }
    if (n > state.students.length) {
      alert("å­¸ç”Ÿäººæ•¸ä¸è¶³");
      return;
    }
    const pool = [...state.students];
    const result = [];
    while (result.length < n) {
      const idx = Math.floor(Math.random() * pool.length);
      result.push(pool.splice(idx,1)[0]);
    }
    out.textContent = result.map(s => `${s.seat}. ${s.name}`).join("ã€");
  }

  /* ================= æŠ½å¡å€ï¼ˆåªé¡¯ç¤ºæ•ˆæœï¼Œä¸è‡ªå‹•æ”¹åˆ†ï¼‰ ================= */
  const rewardCards = [
    {
      id: "all_plus1",
      title: "å°å°å¿ƒæ„",
      desc: "è€å¸«ç‚ºè©²çµ„ +1ã€‚"
    },
    {
      id: "all_plus2",
      title: "2å¦‚åæŒ",
      desc: "è€å¸«ç‚ºè©²çµ„ +2ã€‚"
    },
    {
      id: "choose_one_plus3",
      title: "å¹«åŠ©å¥½å‹",
      desc: "è«‹é¸ä¸€çµ„ï¼Œè€å¸«ç‚ºè©²çµ„åŠ 1åˆ†ã€‚"
    },
    {
      id: "double_group_score",
      title: "é›™å€è£œçµ¦",
      desc: "è€å¸«å¯å°‡è©²çµ„åˆ†æ•¸ x2"
    },
    {
      id: "steal_two_points",
      title: "ç¥å·",
      desc: "è€å¸«å¯å¾å¦ä¸€çµ„æ‰£ 2 åˆ†ï¼Œå†æ‰‹å‹•åŠ  2 åˆ†åˆ°æœ¬çµ„ã€‚"
    },
    {
      id: "thanks_only",
      title: "è¬è¬åƒèˆ‡",
      desc: "ä»Šæ¬¡å””åŠ åˆ†ï¼Œä½†è€å¸«éƒ½è®šè³ä½ çµ„åšå¾—å¥½ã€‚"
    }
  ];

  let shuffledCards = [];
  let selectedCardIndex = null;
  let showAllCardTitles = false;

  function shuffleCards() {
    shuffledCards = [...rewardCards];
    for (let i = shuffledCards.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffledCards[i], shuffledCards[j]] = [shuffledCards[j], shuffledCards[i]];
    }
  }

  function renderCards() {
    const listEl = document.getElementById("cardList");
    const hintEl = document.getElementById("cardHint");
    if (!listEl || !hintEl) return;

    listEl.innerHTML = "";

    shuffledCards.forEach((card, index) => {
      const btn = document.createElement("button");
      btn.className = "reward-card";
      btn.onclick = () => revealCard(index);

      const isSelected = index === selectedCardIndex;
      const showTitle = showAllCardTitles || isSelected;

      if (!showTitle) {
        btn.classList.add("mystery");
        btn.innerHTML = "â“ ç¥ç§˜å¡";
      } else {
        btn.innerHTML = `<strong>${card.title}</strong>`;
        if (isSelected) btn.classList.add("selected");
      }

      listEl.appendChild(btn);
    });

    if (selectedCardIndex == null) {
      hintEl.textContent = "æ­¥é©Ÿï¼šè«‹åŒå­¸å…ˆæ€ä¸€å¼µç¥ç§˜å¡ â†’ é¡¯ç¤ºæ•ˆæœã€‚";
    } else {
      const card = shuffledCards[selectedCardIndex];
      hintEl.textContent =
        `æŠ½åˆ°ï¼šã€Œ${card.title}ã€â€” ${card.desc}ï¼ˆè«‹è€å¸«è‡ªè¡Œç”¨ä¸Šé¢åŠ åˆ†æŒ‰éˆ•è™•ç†ï¼‰`;
    }
  }

  function revealCard(index) {
    selectedCardIndex = index;
    showAllCardTitles = false;
    renderCards();
  }

  function showAllCards() {
    showAllCardTitles = true;
    renderCards();
  }

  function resetCards() {
    selectedCardIndex = null;
    showAllCardTitles = false;
    shuffleCards();
    renderCards();
  }

  /* ================= ä½œæ¥­ç³»çµ± ================= */
  function addHomework() {
    const input = document.getElementById("newHomeworkTitle");
    const title = input.value.trim();
    if (!title) {
      alert("è«‹è¼¸å…¥åŠŸèª²åç¨±");
      return;
    }
    const id = Date.now();
    const hw = {
      id,
      title,
      status: {},
      awarded: []
    };
    state.students.forEach(s => {
      hw.status[s.id] = "æœªç¹³äº¤";
    });

    state.homeworks.push(hw);
    saveState();
    input.value = "";
    renderHomeworkList();
    openHomework(id);
  }

  function renderHomeworkList() {
    const box = document.getElementById("homeworkList");
    if (!box) return;
    box.innerHTML = "";

    state.homeworks.forEach(hw => {
      const submittedCount = Object.values(hw.status)
        .filter(s => s === "å·²ç¹³äº¤" || s === "å¾…è¨‚æ­£" || s === "å·²è¨‚æ­£").length;
      const correctedCount = Object.values(hw.status)
        .filter(s => s === "å·²è¨‚æ­£").length;
      const total = state.students.length;

      const div = document.createElement("div");
      div.className = "hw-card";
      div.innerHTML = `
        <div class="between" style="cursor:pointer;" onclick="openHomework(${hw.id})">
          <strong>${hw.title}</strong>
          <div style="text-align:right;font-size:14px;">
            <div>${submittedCount}/${total} å·²ç¹³äº¤</div>
            <div>${correctedCount}/${total} å·²è¨‚æ­£</div>
          </div>
        </div>
      `;
      box.appendChild(div);
    });
  }

  let currentHW = null;

  function openHomework(id) {
    currentHW = state.homeworks.find(h => h.id === id);
    if (!currentHW) return;

    document.getElementById("hwModalTitle").textContent = currentHW.title;
    const list = document.getElementById("hwModalList");
    list.innerHTML = "";

    const sorted = [...state.students].sort((a,b) => a.seat - b.seat);

    sorted.forEach(stu => {
      const card = document.createElement("div");
      card.className = "hw-stu-card";
      card.dataset.sid = stu.id;

      const status = currentHW.status[stu.id] || "æœªç¹³äº¤";
      const awarded = currentHW.awarded.includes(stu.id);

      const circleClasses = ["circle-check"];
      if (awarded) circleClasses.push("awarded");

      card.innerHTML = `
        <div class="hw-left">
          <strong class="hw-name">${stu.seat}. ${stu.name}</strong>
          <button class="status-btn status-${status}" onclick="changeHWStatus(${stu.id})">
            ${status}
          </button>
        </div>
        <div class="${circleClasses.join(" ")}" onclick="toggleCheck(${stu.id})"></div>
      `;

      list.appendChild(card);
    });

    document.getElementById("hwModalBG").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("hwModalBG").style.display = "none";
  }

  function changeHWStatus(sid) {
    if (!currentHW) return;
    const order = ["æœªç¹³äº¤","å·²ç¹³äº¤","å¾…è¨‚æ­£","å·²è¨‚æ­£"];
    const cur = currentHW.status[sid] || "æœªç¹³äº¤";
    const idx = order.indexOf(cur);
    currentHW.status[sid] = order[(idx + 1) % order.length];
    saveState();
    renderHomeworkList();
    openHomework(currentHW.id);
  }

  function toggleCheck(sid) {
    if (!currentHW) return;

    const card = document.querySelector(`.hw-stu-card[data-sid="${sid}"]`);
    if (!card) return;

    const circle = card.querySelector(".circle-check");

    if (currentHW.awarded.includes(sid)) return;

    circle.classList.toggle("checked");
  }

  function awardOnTime() {
    if (!currentHW) return;

    const listEl = document.getElementById("hwModalList");
    const cards = listEl.querySelectorAll(".hw-stu-card");

    cards.forEach(card => {
      const sid = Number(card.dataset.sid);
      const circle = card.querySelector(".circle-check");
      if (circle.classList.contains("checked") && !currentHW.awarded.includes(sid)) {
        const stu = state.students.find(s => s.id === sid);
        if (stu) {
          stu.totalScore += 1;
          currentHW.awarded.push(sid);
        }
      }
    });

    saveState();
    renderIndividual();
    renderHomeworkList();
    openHomework(currentHW.id);
  }

  function deleteHomework() {
    if (!currentHW) return;
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤åŠŸèª²ï¼Ÿ")) return;
    state.homeworks = state.homeworks.filter(h => h.id !== currentHW.id);
    saveState();
    currentHW = null;
    closeModal();
    renderHomeworkList();
  }

  /* ================= INIT ================= */
  window.addEventListener("DOMContentLoaded", () => {
    loadStateLocal();
    initTabs();
    initAuthUI();

    shuffleCards();   // æŠ½å¡æ´—ç‰Œ
    rerenderAll();
  });

  /* æŠŠ function æ›åˆ° window æ–¹ä¾¿ inline onclick ç”¨ */
  window.addStudent = addStudent;
  window.changePersonalScore = changePersonalScore;
  window.redeemCard = redeemCard;
  window.editStudent = editStudent;
  window.deleteStudent = deleteStudent;

  window.addGroup = addGroup;
  window.deleteGroup = deleteGroup;
  window.changeGroupMemberScore = changeGroupMemberScore;
  window.settleGroup = settleGroup;
  window.renameGroup = renameGroup;

  window.drawLottery = drawLottery;

  window.showAllCards = showAllCards;
  window.resetCards   = resetCards;

  window.addHomework = addHomework;
  window.openHomework = openHomework;
  window.closeModal = closeModal;
  window.changeHWStatus = changeHWStatus;
  window.toggleCheck = toggleCheck;
  window.awardOnTime = awardOnTime;
  window.deleteHomework = deleteHomework;
  window.toggleGroupCollapse = toggleGroupCollapse;
</script>

</body>
</html>
