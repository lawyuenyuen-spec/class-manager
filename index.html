<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>6C ç­ç´šç¶“ç‡Ÿå°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    label {
      font-size: 14px;
      margin-right: 4px;
    }
    input[type="text"],
    input[type="number"] {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.danger {
      background: #ef4444;
      color: white;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    .score {
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 12px;
    }
    .card {
      border-radius: 10px;
      background: #f9fafb;
      padding: 10px 12px;
      margin-top: 12px;
      font-size: 14px;
    }
    .group-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #f3f4f6;
      font-size: 13px;
    }
    .small-tip {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    ol {
      padding-left: 20px;
      margin: 6px 0 0 0;
    }
    @media (max-width: 600px) {
      th, td { font-size: 12px; }
      button { font-size: 12px; padding: 4px 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>6C ç­ç´šç¶“ç‡Ÿå°å¹«æ‰‹</h1>

    <!-- ç­ç´šè¨­å®š -->
    <div class="row">
      <label for="className">ç­ç´šåç¨±ï¼š</label>
      <input type="text" id="className" placeholder="ä¾‹å¦‚ï¼š6C å‹¤å­¸ç­" />
      <button class="secondary" id="saveClassNameBtn">å„²å­˜ç­å</button>
      <span class="badge" id="classNameDisplay"></span>
    </div>

    <!-- æ–°å¢å­¸ç”Ÿ -->
    <div class="row">
      <label for="seatNo">åº§è™Ÿï¼š</label>
      <input type="number" id="seatNo" min="1" style="width: 70px;" />
      <label for="studentName">å§“åï¼š</label>
      <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å" />
      <button class="primary" id="addStudentBtn">æ–°å¢å­¸ç”Ÿ</button>
    </div>

    <!-- ç¸½è¦½ -->
    <div class="card">
      ğŸ‘€ ç­ç´šç¸½åˆ†ï¼š<span id="totalScore">0</span> åˆ†  
      | å­¸ç”Ÿäººæ•¸ï¼š<span id="studentCount">0</span> äºº
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="card">
      <strong>ğŸ† æ’è¡Œæ¦œï¼ˆå‰ 5 åï¼‰</strong>
      <div id="rankingWrapper" class="small-tip">æš«æ™‚æœªæœ‰åˆ†æ•¸å·®è·</div>
      <ol id="rankingList"></ol>
    </div>

    <!-- éš¨æ©ŸæŠ½ç±¤ -->
    <div class="card">
      <div class="row">
        <label for="drawCount">æŠ½å‡ºäººæ•¸ï¼š</label>
        <input type="number" id="drawCount" min="1" value="1" style="width: 70px;" />
        <label style="display:flex;align-items:center;font-size:13px;">
          <input type="checkbox" id="noRepeatCheckbox" checked style="margin-right:4px;" />
          ä¸é‡è¤‡æŠ½ç±¤ï¼ˆç”¨å®Œä¸€è¼ªå…ˆé‡ç½®ï¼‰
        </label>
        <button class="secondary" id="drawBtn">ğŸ² æŠ½ç±¤</button>
        <button class="danger" id="resetDrawPoolBtn">é‡ç½®æŠ½ç±¤æ± </button>
      </div>
      <div id="drawResult" class="group-box">å°šæœªæŠ½ç±¤</div>
      <div class="small-tip">
        æç¤ºï¼šä¸é‡è¤‡æ¨¡å¼ä¸‹ï¼Œç³»çµ±æœƒç”¨å®Œæ¯ä½åŒå­¸ä¸€æ¬¡ï¼Œå…ˆæœƒé‡æ–°é–‹å§‹ã€‚
      </div>
    </div>

    <!-- éš¨æ©Ÿåˆ†çµ„ -->
    <div class="card">
      <div class="row">
        <label for="groupSize">æ¯çµ„äººæ•¸ï¼š</label>
        <input type="number" id="groupSize" min="2" max="8" value="4" style="width: 70px;" />
        <button class="secondary" id="randomGroupBtn">ğŸ“š ä¸€éµéš¨æ©Ÿåˆ†çµ„</button>
      </div>
      <div id="groupResult" class="group-box"></div>
    </div>

    <!-- å­¸ç”Ÿè¡¨æ ¼ -->
    <table>
      <thead>
        <tr>
          <th>åº§è™Ÿ</th>
          <th>å§“å</th>
          <th>åˆ†æ•¸</th>
          <th>æ“ä½œ</th>
          <th>ç§»é™¤</th>
        </tr>
      </thead>
      <tbody id="studentTableBody">
        <!-- JS ç”¢ç”Ÿ -->
      </tbody>
    </table>
  </div>

  <script>
    const STORAGE_KEY = "classManager6C";

    let state = {
      className: "",
      students: [],  // { id, seatNo, name, score }
      drawPool: []   // å­˜ä½æœªè¢«æŠ½éçš„å­¸ç”Ÿ idï¼ˆä¸é‡è¤‡æŠ½ç±¤ç”¨ï¼‰
    };

    // è®€å– localStorage
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data && Array.isArray(data.students)) {
          state.className = data.className || "";
          state.students = data.students;
          state.drawPool = Array.isArray(data.drawPool) ? data.drawPool : [];
        }
      } catch (e) {
        console.error("è¼‰å…¥è³‡æ–™å¤±æ•—", e);
      }
    }

    // å„²å­˜åˆ° localStorage
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function render() {
      // ç­å
      const classNameDisplay = document.getElementById("classNameDisplay");
      const classNameInput = document.getElementById("className");
      classNameInput.value = state.className || "";
      classNameDisplay.textContent = state.className || "ï¼ˆæœªè¨­å®šç­åï¼‰";

      // å­¸ç”Ÿè¡¨æ ¼
      const tbody = document.getElementById("studentTableBody");
      tbody.innerHTML = "";

      let total = 0;
      state.students
        .slice()
        .sort((a, b) => Number(a.seatNo) - Number(b.seatNo))
        .forEach((stu) => {
        total += stu.score;
        const tr = document.createElement("tr");

        const tdSeat = document.createElement("td");
        tdSeat.textContent = stu.seatNo;
        tr.appendChild(tdSeat);

        const tdName = document.createElement("td");
        tdName.textContent = stu.name;
        tr.appendChild(tdName);

        const tdScore = document.createElement("td");
        tdScore.innerHTML = `<span class="score">${stu.score}</span>`;
        tr.appendChild(tdScore);

        const tdActions = document.createElement("td");
        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+1";
        plusBtn.className = "primary";
        plusBtn.onclick = () => changeScore(stu.id, 1);

        const minusBtn = document.createElement("button");
        minusBtn.textContent = "-1";
        minusBtn.className = "secondary";
        minusBtn.style.marginLeft = "4px";
        minusBtn.onclick = () => changeScore(stu.id, -1);

        tdActions.appendChild(plusBtn);
        tdActions.appendChild(minusBtn);
        tr.appendChild(tdActions);

        const tdRemove = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆªé™¤";
        delBtn.className = "danger";
        delBtn.onclick = () => removeStudent(stu.id);
        tdRemove.appendChild(delBtn);
        tr.appendChild(tdRemove);

        tbody.appendChild(tr);
      });

      // ç¸½åˆ†ï¼äººæ•¸
      document.getElementById("totalScore").textContent = total;
      document.getElementById("studentCount").textContent = state.students.length;

      renderRanking();
    }

    // æ’è¡Œæ¦œ
    function renderRanking() {
      const rankingList = document.getElementById("rankingList");
      const rankingWrapper = document.getElementById("rankingWrapper");
      rankingList.innerHTML = "";

      if (state.students.length === 0) {
        rankingWrapper.textContent = "å°šæœªåŠ å…¥å­¸ç”Ÿ";
        return;
      }

      const ranked = state.students
        .slice()
        .sort((a, b) => b.score - a.score);

      if (ranked.length === 0 || ranked[0].score === 0) {
        rankingWrapper.textContent = "æš«æ™‚æœªæœ‰åˆ†æ•¸å·®è·";
        return;
      }

      rankingWrapper.textContent = "";
      ranked.slice(0, 5).forEach((stu, index) => {
        const li = document.createElement("li");
        li.textContent = `${stu.seatNo}.${stu.name}ï¼ˆ${stu.score}åˆ†ï¼‰`;
        rankingList.appendChild(li);
      });
    }

    function addStudent() {
      const seatInput = document.getElementById("seatNo");
      const nameInput = document.getElementById("studentName");
      const seatNo = seatInput.value.trim();
      const name = nameInput.value.trim();

      if (!seatNo || !name) {
        alert("è«‹è¼¸å…¥åº§è™Ÿå’Œå§“å");
        return;
      }

      // æª¢æŸ¥é‡è¤‡åº§è™Ÿ
      if (state.students.some((s) => String(s.seatNo) === String(seatNo))) {
        if (!confirm("å·²ç¶“æœ‰ç›¸åŒåº§è™Ÿï¼Œç¢ºå®šè¦å†æ–°å¢å—ï¼Ÿ")) return;
      }

      const newStudent = {
        id: Date.now() + Math.random(),
        seatNo,
        name,
        score: 0
      };
      state.students.push(newStudent);

      // æ¯æ¬¡æ”¹å‹•å­¸ç”Ÿåå–®ï¼Œå°±é‡ç½®æŠ½ç±¤æ± 
      resetDrawPool(false);

      saveState();
      render();

      seatInput.value = "";
      nameInput.value = "";
      seatInput.focus();
    }

    function changeScore(id, delta) {
      const stu = state.students.find((s) => s.id === id);
      if (!stu) return;
      stu.score += delta;
      saveState();
      render();
    }

    function removeStudent(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿï¼Ÿ")) return;
      state.students = state.students.filter((s) => s.id !== id);
      resetDrawPool(false);
      saveState();
      render();
    }

    function saveClassName() {
      const input = document.getElementById("className");
      state.className = input.value.trim();
      saveState();
      render();
    }

    // åˆå§‹åŒ–ï¼é‡ç½®æŠ½ç±¤æ± 
    function resetDrawPool(showMessage = true) {
      state.drawPool = state.students.map((s) => s.id);
      saveState();
      if (showMessage) {
        document.getElementById("drawResult").textContent = "æŠ½ç±¤æ± å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°æŠ½ç±¤ã€‚";
      }
    }

    // éš¨æ©ŸæŠ½ç±¤
    function randomDraw() {
      const drawCountInput = document.getElementById("drawCount");
      const noRepeatCheckbox = document.getElementById("noRepeatCheckbox");
      const drawResultDiv = document.getElementById("drawResult");

      let count = Number(drawCountInput.value);
      if (!count || count < 1) count = 1;

      if (state.students.length === 0) {
        alert("è«‹å…ˆæ–°å¢å­¸ç”Ÿ");
        return;
      }

      const noRepeat = noRepeatCheckbox.checked;

      let selectedStudents = [];

      if (!noRepeat) {
        // å…è¨±é‡è¤‡ï¼šæ¯æ¬¡å¾æ‰€æœ‰å­¸ç”Ÿä¸­æŠ½
        for (let i = 0; i < count; i++) {
          const randomIndex = Math.floor(Math.random() * state.students.length);
          selectedStudents.push(state.students[randomIndex]);
        }
      } else {
        // ä¸é‡è¤‡æŠ½ç±¤ï¼šç”¨ drawPool
        if (!Array.isArray(state.drawPool) || state.drawPool.length === 0) {
          // å¦‚æœæŠ½ç±¤æ± ç©ºï¼Œé‡æ–°å»ºç«‹
          resetDrawPool(false);
        }

        if (state.drawPool.length === 0) {
          alert("ç›®å‰æ²’æœ‰å¯æŠ½çš„å­¸ç”Ÿï¼Œè«‹é‡ç½®æŠ½ç±¤æ± ã€‚");
          return;
        }

        const pool = [...state.drawPool];
        selectedStudents = [];

        for (let i = 0; i < count; i++) {
          if (pool.length === 0) break;
          const index = Math.floor(Math.random() * pool.length);
          const id = pool.splice(index, 1)[0];
          const stu = state.students.find((s) => s.id === id);
          if (stu) selectedStudents.push(stu);
        }

        state.drawPool = pool;
        saveState();
      }

      if (selectedStudents.length === 0) {
        drawResultDiv.textContent = "æš«æ™‚ç„¡æ³•æŠ½å‡ºå­¸ç”Ÿï¼Œå¯èƒ½äººæ•¸ä¸è¶³ã€‚";
        return;
      }

      const text = selectedStudents
        .map((s) => `${s.seatNo}.${s.name}ï¼ˆ${s.score}åˆ†ï¼‰`)
        .join("ã€");

      drawResultDiv.textContent = `è¢«æŠ½ä¸­çš„åŒå­¸ï¼š${text}`;

      if (noRepeat && state.drawPool.length === 0) {
        drawResultDiv.textContent += " ï½œ å·²ç”¨å®Œä¸€è¼ªï¼Œè«‹æŒ‰ã€Œé‡ç½®æŠ½ç±¤æ± ã€é‡æ–°é–‹å§‹ã€‚";
      }
    }

    // éš¨æ©Ÿåˆ†çµ„
    function randomGroup() {
      const sizeInput = document.getElementById("groupSize");
      const resultDiv = document.getElementById("groupResult");
      const size = Number(sizeInput.value);

      if (!size || size < 2) {
        alert("è«‹è¨­å®šæ¯çµ„è‡³å°‘ 2 äºº");
        return;
      }
      if (state.students.length < 2) {
        alert("å­¸ç”Ÿå¤ªå°‘ï¼Œç„¡æ³•åˆ†çµ„");
        return;
      }

      const shuffled = [...state.students].sort(() => Math.random() - 0.5);
      const groups = [];
      for (let i = 0; i < shuffled.length; i += size) {
        groups.push(shuffled.slice(i, i + size));
      }

      let html = "";
      groups.forEach((group, index) => {
        const members = group
          .map((s) => `${s.seatNo}.${s.name}ï¼ˆ${s.score}åˆ†ï¼‰`)
          .join("ã€");
        html += `<div>ç¬¬ ${index + 1} çµ„ï¼š${members}</div>`;
      });
      resultDiv.innerHTML = html;
    }

    // ç¶å®šäº‹ä»¶
    document.getElementById("addStudentBtn").onclick = addStudent;
    document.getElementById("saveClassNameBtn").onclick = saveClassName;
    document.getElementById("randomGroupBtn").onclick = randomGroup;
    document.getElementById("drawBtn").onclick = randomDraw;
    document.getElementById("resetDrawPoolBtn").onclick = () => resetDrawPool(true);

    // åˆå§‹åŒ–
    loadState();
    render();
  </script>
</body>
</html>
