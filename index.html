<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å®¤ç®¡ç†å°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: #222;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 15px;
      color: #555;
    }

    .tab-btn.active {
      background: white;
      font-weight: bold;
      color: #111;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    /* Pages */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Inputs */
    input[type="text"], input[type="number"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
    }

    /* Card */
    .card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .flex {
      display: flex;
      align-items: center;
    }

    .between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .score-num {
      font-size: 24px;
      font-weight: bold;
      margin: 4px 0;
    }

    .plus-btn, .minus-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .plus-btn {
      background: #16a34a;
    }

    .minus-btn {
      background: #dc2626;
    }

    .redeem-btn {
      margin-top: 4px;
      background: #9333ea;
      color: white;
      width: 100%;
      border-radius: 6px;
    }

    /* Group page skeleton */
    .group-section {
      display: flex;
      gap: 20px;
    }

    .group-col {
      flex: 1;
    }

    .group-card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    /* Homework skeleton */
    .hw-card {
      padding: 12px;
      border-radius: 12px;
      background: white;
      margin-bottom: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
<div class="container">

  <h1>èª²å®¤ç®¡ç†å°å¹«æ‰‹</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-page="page-individual">å€‹äººè¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-group">å°çµ„è¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-homework">ä½œæ¥­è¨‚æ­£</button>
  </div>
<script>

/* -------------------------------
   ğŸŸ¦ å°çµ„ï¼šæ–°å¢å°çµ„
-------------------------------- */
function addGroup() {
  const id = Date.now();
  state.groups.push({
    id,
    name: "æ–°å°çµ„",
    memberIds: [],
    groupScore: 0
  });

  saveState();
  renderGroups();
}

/* -------------------------------
   ğŸŸ¦ å°çµ„ï¼šæ¸²æŸ“æ•´å€‹çµ„åˆ—è¡¨
-------------------------------- */
function renderGroups() {
  const box = document.getElementById("groupList");
  const ungroupedBox = document.getElementById("ungroupedList");

  box.innerHTML = "";
  ungroupedBox.innerHTML = "";

  // å…ˆæ¸²æŸ“æœªåˆ†çµ„å­¸ç”Ÿï¼ˆå·¦å´ï¼‰
  state.students.forEach(stu => {
    const isGrouped = state.groups.some(g => g.memberIds.includes(stu.id));
    if (!isGrouped) {
      const card = makeStudentMiniCard(stu);
      ungroupedBox.appendChild(card);
    }
  });

  // æ¸²æŸ“å„çµ„
  state.groups.forEach(group => {
    const card = makeGroupCard(group);
    box.appendChild(card);
  });

  enableDrag();
}

/* -------------------------------
   ğŸŸ¦ å»ºç«‹ã€Œæœªåˆ†çµ„ã€å­¸ç”Ÿå°å¡
-------------------------------- */
function makeStudentMiniCard(stu) {
  const div = document.createElement("div");
  div.className = "student-card";
  div.draggable = true;
  div.dataset.sid = stu.id;

  div.innerHTML = `
    <div><strong>${stu.seat}. ${stu.name}</strong></div>
    <div style="color:#999;font-size:13px;">æœªåˆ†çµ„</div>
  `;

  return div;
}

/* -------------------------------
   ğŸŸ¦ å»ºç«‹å°çµ„å¡ç‰‡ï¼ˆå«çµ„å“¡åˆ—è¡¨ï¼‰
-------------------------------- */
function makeGroupCard(group) {
  const div = document.createElement("div");
  div.className = "group-card";
  div.dataset.gid = group.id;

  // è¨ˆç®— groupScore = çµ„å“¡å€‹äººåˆ†ç¸½å’Œ
  group.groupScore = group.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  /* çµ„å¡ HTML */
  div.innerHTML = `
    <div class="between">
      <input class="group-name-input" value="${group.name}"
        onchange="renameGroup(${group.id}, this.value)"
        style="font-size:16px;font-weight:bold;width:120px;border:none;background:#fff;">
      <div><strong>${group.groupScore} åˆ†</strong></div>
    </div>

    <div class="group-members" style="margin-top:10px;">
      ${renderGroupMembers(group)}
    </div>

    <button class="btn-primary" style="margin-top:10px;"
      onclick="settleGroup(${group.id})">
      çµç®—
    </button>
  `;

  return div;
}

/* -------------------------------
   ğŸŸ¦ æ¸²æŸ“çµ„å“¡ + æ¯äººå€‹äºº +1/-1
-------------------------------- */
function renderGroupMembers(group) {
  let html = "";

  group.memberIds.forEach(id => {
    const stu = state.students.find(s => s.id === id);
    if (!stu) return;

    html += `
      <div class="between" style="margin-bottom:6px;" draggable="true" data-sid="${stu.id}">
        <span>${stu.seat}. ${stu.name}</span>

        <span>
          <button class="minus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, -1)">âˆ’</button>
          <button class="plus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, +1)">+</button>
        </span>

        <span style="font-weight:bold;">${stu.individualGroupScoreToday}</span>
      </div>
    `;
  });

  return html;
}

/* -------------------------------
   ğŸŸ¦ ä¿®æ”¹çµ„å
-------------------------------- */
function renameGroup(id, newName) {
  const g = state.groups.find(g => g.id === id);
  if (!g) return;

  g.name = newName.trim();
  saveState();
  renderGroups();
}

</script>
<script>

/* -------------------------------
   ğŸŸ§ æ‹–æ›³åŠŸèƒ½ï¼ˆå­¸ç”Ÿ â†’ å°çµ„ï¼‰
-------------------------------- */
function enableDrag() {
  const draggables = document.querySelectorAll("[draggable='true'][data-sid]");
  const groupCards = document.querySelectorAll(".group-card");

  draggables.forEach(item => {
    item.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", item.dataset.sid);
    });
  });

  groupCards.forEach(card => {
    card.addEventListener("dragover", e => e.preventDefault());

    card.addEventListener("drop", e => {
      e.preventDefault();
      const sid = Number(e.dataTransfer.getData("text/plain"));
      const gid = Number(card.dataset.gid);
      moveStudentToGroup(sid, gid);
    });
  });

  // å·¦å´ã€Œæœªåˆ†çµ„ã€
  const ungroup = document.getElementById("ungroupedList");
  ungroup.addEventListener("dragover", e => e.preventDefault());
  ungroup.addEventListener("drop", e => {
    e.preventDefault();
    const sid = Number(e.dataTransfer.getData("text/plain"));
    removeFromGroup(sid);
  });
}

/* -------------------------------
   ğŸŸ§ ç§»å‹•å­¸ç”Ÿ â†’ å°çµ„
-------------------------------- */
function moveStudentToGroup(sid, gid) {
  // ç§»é™¤å­¸ç”Ÿåœ¨æ‰€æœ‰çµ„åˆ¥
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });

  // åŠ å…¥æ–°çµ„
  const group = state.groups.find(g => g.id === gid);
  group.memberIds.push(sid);

  saveState();
  renderGroups();
}

/* -------------------------------
   ğŸŸ§ ç§»é™¤å­¸ç”Ÿ â†’ æœªåˆ†çµ„
-------------------------------- */
function removeFromGroup(sid) {
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });

  state.students.find(s => s.id === sid).individualGroupScoreToday = 0;

  saveState();
  renderGroups();
}
</script>
<script>

/* -------------------------------
   ğŸŸ© å€‹äººçµ„å…§ + / âˆ’ï¼ˆå½±éŸ¿ individualGroupScoreTodayï¼‰
-------------------------------- */
function changeGroupMemberScore(sid, delta) {
  const stu = state.students.find(s => s.id === sid);
  if (!stu) return;

  stu.individualGroupScoreToday += delta;
  if (stu.individualGroupScoreToday < 0) stu.individualGroupScoreToday = 0;

  saveState();
  renderGroups();
  renderDangerZone();
  renderGroupRanking();
}

/* -------------------------------
   ğŸŸ© æŒ‰ã€Œçµç®—ã€åˆ†é…çµ„åˆ† â†’ åŠ å» totalScore
-------------------------------- */
function settleGroup(gid) {
  const group = state.groups.find(g => g.id === gid);
  if (!group) return;

  // è¨ˆç®—çµ„åˆ†
  const groupScore = group.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  if (groupScore === 0) {
    alert("çµ„åˆ†ç‚º 0ï¼Œä¸èƒ½çµç®—");
    return;
  }

  // å…¨çµ„åŠ ä¸Š groupScore
  group.memberIds.forEach(id => {
    const stu = state.students.find(s => s.id === id);
    stu.totalScore += groupScore;
    stu.individualGroupScoreToday = 0;
  });

  // çµ„åˆ†æ­¸é›¶
  group.groupScore = 0;

  saveState();
  renderGroups();
  renderIndividualPage();
  renderDangerZone();
  renderGroupRanking();
}

/* -------------------------------
   âš ï¸ å±éšªå€ï¼šindividualGroupScoreToday = 0
-------------------------------- */
function renderDangerZone() {
  const box = document.getElementById("dangerZone");
  box.innerHTML = "";

  const zeroList = state.students.filter(s => s.individualGroupScoreToday === 0);

  if (zeroList.length === 0) {
    box.innerHTML = "<div>ç„¡å­¸ç”Ÿåœ¨å±éšªå€ã€‚</div>";
    return;
  }

  zeroList.forEach(stu => {
    const div = document.createElement("div");
    div.textContent = `${stu.seat}. ${stu.name}ï¼ˆ0 åˆ†ï¼‰`;
    box.appendChild(div);
  });
}

/* -------------------------------
   ğŸ† åˆ†çµ„æ’åï¼ˆä¾ groupScoreï¼‰
-------------------------------- */
function renderGroupRanking() {
  const box = document.getElementById("groupRanking");
  box.innerHTML = "";

  const rank = [...state.groups]
    .map(g => {
      const score = g.memberIds
        .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
        .reduce((a, b) => a + b, 0);
      return { name: g.name, score };
    })
    .sort((a, b) => b.score - a.score);

  rank.forEach((g, i) => {
    const div = document.createElement("div");
    div.textContent = `ç¬¬ ${i + 1} åï¼š${g.name}ï¼ˆ${g.score} åˆ†ï¼‰`;
    box.appendChild(div);
  });
}

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  renderIndividualPage();
  renderGroups();
  renderDangerZone();
  renderGroupRanking();
});
</script>
<!-- ========================= -->
<!--  PAGE 2: å°çµ„è¨ˆåˆ†é ï¼ˆéª¨æ¶ï¼‰  -->
<!-- ========================= -->
<div id="page-group" class="page">

  <h2>å°çµ„è¨ˆåˆ†ï¼ˆå»ºæ§‹ä¸­ Â· Step 2 åŠ åŠŸèƒ½ï¼‰</h2>

  <p style="color:#555;">
    â¤ å·¦é‚Šï¼šæœªåˆ†çµ„å­¸ç”Ÿ  
    â¤ å³é‚Šï¼šå°çµ„ï¼ˆå¯æ‹–æ›³å­¸ç”Ÿï¼‰  
    â¤ æ¯å€‹çµ„éƒ½æœ‰ï¼šå€‹äººåˆ†ã€çµ„åˆ†ã€è‡ªå‹•çµç®—ï¼ˆä¸‹ä¸€æ­¥åŠ å…¥ï¼‰
  </p>

  <div class="group-section">

    <!-- å·¦å´ï¼šæœªåˆ†çµ„å­¸ç”Ÿ -->
    <div class="group-col">
      <h3>æœªåˆ†çµ„å­¸ç”Ÿ</h3>
      <div id="ungroupedList" class="student-list">
        <!-- ä¹‹å¾ŒæœƒåŠ å…¥æ‹–æ›³ -->
      </div>
    </div>

    <!-- å³å´ï¼šå°çµ„ -->
    <div class="group-col">
      <h3>å°çµ„åˆ—è¡¨</h3>

      <!-- å¾…åŠ å…¥åŠŸèƒ½ï¼šæ–°å¢å°çµ„æŒ‰éˆ• -->
      <button class="btn-primary" onclick="alert('å°çµ„åŠŸèƒ½æœƒåœ¨ Step 2 å»ºå¥½ï¼')">
        ï¼‹ æ–°å¢å°çµ„
      </button>

      <div id="groupList" style="margin-top:12px;">
        <!-- å°çµ„å¡ç‰‡æœƒåœ¨ Step 2 ç”Ÿæˆ -->
      </div>
    </div>

  </div>

  <hr style="margin:24px 0;">

  <!-- å±éšªå€ / åˆ†çµ„æ’åï¼ˆStep 2 åŠ ï¼‰ -->
  <div>
    <h3>åˆ†çµ„æ’åï¼ˆStep 2 åŠ ï¼‰</h3>
    <div id="groupRanking"></div>

    <h3 style="margin-top:20px;">âš ï¸ å±éšªå€ï¼ˆä»Šæ—¥æœªå¾—åˆ†ï¼‰</h3>
    <div id="dangerZone"></div>
  </div>

</div>

<!-- ========================= -->
<!--  PAGE 3: ä½œæ¥­è¨‚æ­£é ï¼ˆéª¨æ¶ï¼‰ -->
<!-- ========================= -->
<div id="page-homework" class="page">
  <h2>ä½œæ¥­è¨‚æ­£ï¼ˆå»ºæ§‹ä¸­ Â· Step 2 åŠ åŠŸèƒ½ï¼‰</h2>

  <div style="margin-bottom:12px;">
    <input id="newHomeworkTitle" type="text" placeholder="è¼¸å…¥åŠŸèª²åç¨±">
    <button class="btn-primary"
      onclick="alert('ä½œæ¥­åŠŸèƒ½æœƒåœ¨ Step 2 åŠ å…¥ï¼')">
      ï¼‹ æ–°å¢åŠŸèª²
    </button>
  </div>

  <div id="homeworkList">
    <!-- åŠŸèª²å¡ç‰‡æœƒåœ¨ Step 2 åŠ å…¥ -->
  </div>
</div>

<!-- ========================= -->
<!--  NEW STUDENT SECTION      -->
<!-- ========================= -->

<hr style="margin:30px 0;">

<h2>æ–°å¢å­¸ç”Ÿ</h2>

<div class="card">
  <div style="display:flex; gap:12px; align-items:center;">
    <input id="newSeat" type="number" placeholder="åº§è™Ÿ" style="width:90px;">
    <input id="newName" type="text" placeholder="å§“å">
    <button class="btn-primary" onclick="addStudent()">æ–°å¢</button>
  </div>
</div>

<!-- ========================= -->
<!--  HTML END                -->
<!-- ========================= -->

</div> <!-- container end -->
</body>
</html>
