<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èª²å®¤ç®¡ç†å°å¹«æ‰‹ Classroom Manager v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: #222;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 15px;
      color: #555;
    }

    .tab-btn.active {
      background: white;
      font-weight: bold;
      color: #111;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    /* Pages */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Inputs */
    input[type="text"], input[type="number"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
    }

    /* Card */
    .card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .flex {
      display: flex;
      align-items: center;
    }

    .between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .score-num {
      font-size: 24px;
      font-weight: bold;
      margin: 4px 0;
    }

    .plus-btn, .minus-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .plus-btn {
      background: #16a34a;
    }

    .minus-btn {
      background: #dc2626;
    }

    .redeem-btn {
      margin-top: 4px;
      background: #9333ea;
      color: white;
      width: 100%;
      border-radius: 6px;
    }

    /********* Group page *********/
    .group-section {
      display: flex;
      gap: 20px;
    }

    .group-col {
      flex: 1;
    }

    .group-card {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    /******** Homework ********/
    .hw-card {
      padding: 12px;
      border-radius: 12px;
      background: white;
      margin-bottom: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
<div class="container">

  <h1>èª²å®¤ç®¡ç†å°å¹«æ‰‹ Classroom Manager v4</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-page="page-individual">å€‹äººè¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-group">å°çµ„è¨ˆåˆ†</button>
    <button class="tab-btn" data-page="page-homework">ä½œæ¥­è¨‚æ­£</button>
  </div>
<script>
/* ===========================================================
   ğŸ§   STATEï¼šè³‡æ–™æ¨¡å‹ï¼ˆæ‰€æœ‰è³‡æ–™éƒ½å­˜æ”¾åœ¨é€™ï¼‰
   =========================================================== */
let state = {
  students: [
    // { id, seat, name, totalScore, individualGroupScoreToday }
  ],

  groups: [
    // { id, name, memberIds: [], groupScore }
  ],

  homeworks: [
    // reserved for Step 3
  ]
};

const STORAGE_KEY = "class_manager_v4";

/* ===========================================================
   ğŸ’¾  LocalStorageï¼šå„²å­˜ & è¼‰å…¥
   =========================================================== */
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      state = JSON.parse(saved);
    } catch (e) {
      console.error("State load error:", e);
    }
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ===========================================================
   â• æ–°å¢å­¸ç”Ÿ
   =========================================================== */
function addStudent() {
  const seat = document.getElementById("newSeat").value.trim();
  const name = document.getElementById("newName").value.trim();

  if (!seat || !name) {
    alert("è«‹è¼¸å…¥åº§è™Ÿèˆ‡å§“å");
    return;
  }

  state.students.push({
    id: Date.now(),
    seat,
    name,
    totalScore: 0,
    individualGroupScoreToday: 0
  });

  saveState();
  renderIndividualPage();
  renderGroups();

  document.getElementById("newSeat").value = "";
  document.getElementById("newName").value = "";
}

/* ===========================================================
   ğŸ§® å€‹äººè¨ˆåˆ†é ï¼šåŠ åˆ† / æ‰£åˆ† / å…Œæ›å¡
   =========================================================== */
function changePersonalScore(id, delta) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  stu.totalScore += delta;
  if (stu.totalScore < 0) stu.totalScore = 0;

  saveState();
  renderIndividualPage();
}

function redeemCard(id) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  if (stu.totalScore < 5) {
    alert("åˆ†æ•¸ä¸è¶³ï¼Œä¸èƒ½å…Œæ›å¡ï¼");
    return;
  }

  stu.totalScore -= 5;

  saveState();
  renderIndividualPage();
}

/* ===========================================================
   ğŸ‘¤ å€‹äººè¨ˆåˆ†é ï¼šæ¸²æŸ“
   =========================================================== */
function renderIndividualPage() {
  const container = document.getElementById("individualList");
  container.innerHTML = "";

  const sorted = [...state.students].sort((a, b) => Number(a.seat) - Number(b.seat));

  sorted.forEach(stu => {
    const card = document.createElement("div");
    card.className = "student-card";

    card.innerHTML = `
  <div class="between">
    <strong>${stu.seat}. ${stu.name}</strong>

   <div style="display:flex; gap:6px; align-items:center;">
    <div class="score-num">${stu.totalScore}</div>

    <button class="btn-secondary" style="padding:4px 8px;font-size:12px;"
      onclick="editStudent(${stu.id})">
      ç·¨è¼¯
    </button>

    <button class="btn-danger" style="padding:4px 8px;font-size:12px;"
      onclick="deleteStudent(${stu.id})">
      åˆªé™¤
    </button>
</div>
/* ===========================================================
   âœï¸ ç·¨è¼¯å­¸ç”Ÿï¼ˆåº§è™Ÿ + åå­—ï¼‰
   =========================================================== */
function editStudent(id) {
  const stu = state.students.find(s => s.id === id);
  if (!stu) return;

  const newSeat = prompt("ä¿®æ”¹åº§è™Ÿï¼š", stu.seat);
  if (newSeat === null) return;

  const newName = prompt("ä¿®æ”¹åå­—ï¼š", stu.name);
  if (newName === null) return;

  stu.seat = newSeat.trim();
  stu.name = newName.trim();

  saveState();

  // æ›´æ–°æ‰€æœ‰é é¢
  renderIndividualPage();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

  </div>

  <div class="between" style="margin-top:6px;">
    <button class="minus-btn" onclick="changePersonalScore(${stu.id}, -1)">âˆ’</button>
    <button class="plus-btn" onclick="changePersonalScore(${stu.id}, +1)">+</button>
  </div>

  <button class="redeem-btn" onclick="redeemCard(${stu.id})">
    å…Œæ›ä¸€å¼µå¡ï¼ˆ-5åˆ†ï¼‰
  </button>
`;

    `;

    container.appendChild(card);
  });
}

/* ===========================================================
   ğŸ—‚ï¸ Tabs åˆ‡æ›
   =========================================================== */
function initTabs() {
  const tabs = document.querySelectorAll(".tab-btn");
  const pages = document.querySelectorAll(".page");

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.page;

      // Tab active ç‹€æ…‹
      tabs.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      // Page active ç‹€æ…‹
      pages.forEach(p => {
        p.classList.toggle("active", p.id === target);
      });
    });
  });
}

/* ===========================================================
   ğŸš€ INIT
   =========================================================== */
loadState();

document.addEventListener("DOMContentLoaded", () => {
  initTabs();
  renderIndividualPage();
});
</script>
<script>
/* ===========================================================
   ğŸŸ¦ æ–°å¢å°çµ„
   =========================================================== */
function addGroup() {
  const id = Date.now();
  state.groups.push({
    id,
    name: "æ–°å°çµ„",
    memberIds: [],
    groupScore: 0
  });
  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ¦ æ¸²æŸ“æ‰€æœ‰å°çµ„ + æœªåˆ†çµ„å­¸ç”Ÿ
   =========================================================== */
function renderGroups() {
  const box = document.getElementById("groupList");
  const ungroupedBox = document.getElementById("ungroupedList");

  box.innerHTML = "";
  ungroupedBox.innerHTML = "";

  // å·¦é‚Šï¼šæœªåˆ†çµ„å­¸ç”Ÿ
  state.students.forEach(stu => {
    const isGrouped = state.groups.some(g => g.memberIds.includes(stu.id));
    if (!isGrouped) {
      const card = makeStudentMiniCard(stu);
      ungroupedBox.appendChild(card);
    }
  });

  // å³é‚Šï¼šå°çµ„åˆ—è¡¨
  state.groups.forEach(group => {
    const card = makeGroupCard(group);
    box.appendChild(card);
  });

  enableDrag();
}

/* ===========================================================
   ğŸŸ¦ æœªåˆ†çµ„å­¸ç”Ÿå°å¡
   =========================================================== */
function makeStudentMiniCard(stu) {
  const div = document.createElement("div");
  div.className = "student-card";
  div.draggable = true;
  div.dataset.sid = stu.id;

  div.innerHTML = `
    <strong>${stu.seat}. ${stu.name}</strong>
    <div style="color:#888;font-size:13px;">æœªåˆ†çµ„</div>
  `;
  return div;
}

/* ===========================================================
   ğŸŸ¦ å°çµ„å¡
   =========================================================== */
function makeGroupCard(group) {
  const div = document.createElement("div");
  div.className = "group-card";
  div.dataset.gid = group.id;

  // è¨ˆç®—çµ„åˆ†
  group.groupScore = group.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  div.innerHTML = `
    <div class="between">
      <input value="${group.name}" 
             onchange="renameGroup(${group.id}, this.value)"
             style="border:none;font-weight:bold;font-size:16px;">
      <strong>${group.groupScore} åˆ†</strong>
    </div>

    <div class="group-members" style="margin-top:10px;">
      ${renderGroupMembers(group)}
    </div>

    <button class="btn-primary" style="margin-top:10px;"
        onclick="settleGroup(${group.id})">
      çµç®—
    </button>
  `;

  return div;
}

/* ===========================================================
   ğŸŸ¦ çµ„å…§æˆå“¡ + å€‹äººåˆ†æŒ‰éˆ•
   =========================================================== */
function renderGroupMembers(group) {
  let html = "";
  const members = group.memberIds
    .map(id => state.students.find(s => s.id === id))
    .sort((a, b) => Number(a.seat) - Number(b.seat));

  members.forEach(stu => {
    html += `
      <div class="between" draggable="true" data-sid="${stu.id}" style="margin-bottom:6px;">
        <span>${stu.seat}. ${stu.name}</span>
        <span>
          <button class="minus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, -1)">âˆ’</button>
          <button class="plus-btn" style="width:26px;height:26px;"
            onclick="changeGroupMemberScore(${stu.id}, +1)">+</button>
        </span>
        <strong>${stu.individualGroupScoreToday}</strong>
      </div>
    `;
  });

  return html;
}

/* ===========================================================
   ğŸŸ¦ ä¿®æ”¹çµ„å
   =========================================================== */
function renameGroup(id, newName) {
  const g = state.groups.find(g => g.id === id);
  if (!g) return;
  g.name = newName.trim();
  saveState();
  renderGroups();
}

/* ===========================================================
   ğŸŸ§ æ‹–æ›³ï¼šå•Ÿç”¨ Drag & Drop
   =========================================================== */
function enableDrag() {
  const draggables = document.querySelectorAll("[draggable='true'][data-sid]");
  const groupCards = document.querySelectorAll(".group-card");

  draggables.forEach(item => {
    item.addEventListener("dragstart", e => {
      e.dataTransfer.setData("sid", e.target.dataset.sid);
    });
  });

  groupCards.forEach(card => {
    card.addEventListener("dragover", e => e.preventDefault());
    card.addEventListener("drop", e => {
      const sid = Number(e.dataTransfer.getData("sid"));
      const gid = Number(card.dataset.gid);
      moveStudentToGroup(sid, gid);
    });
  });

  const ungrouped = document.getElementById("ungroupedList");
  ungrouped.addEventListener("dragover", e => e.preventDefault());
  ungrouped.addEventListener("drop", e => {
    const sid = Number(e.dataTransfer.getData("sid"));
    removeFromGroup(sid);
  });
}

/* ===========================================================
   ğŸŸ§ ç§»å‹•å­¸ç”Ÿ â†’ å°çµ„
   =========================================================== */
function moveStudentToGroup(sid, gid) {
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });
  const group = state.groups.find(g => g.id === gid);
  group.memberIds.push(sid);

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ§ ç§»é™¤å­¸ç”Ÿ â†’ æœªåˆ†çµ„
   =========================================================== */
function removeFromGroup(sid) {
  state.groups.forEach(g => {
    g.memberIds = g.memberIds.filter(id => id !== sid);
  });
  const stu = state.students.find(s => s.id === sid);
  if (stu) stu.individualGroupScoreToday = 0;

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ© å€‹äººçµ„å…§ + / âˆ’
   =========================================================== */
function changeGroupMemberScore(sid, delta) {
  const stu = state.students.find(s => s.id === sid);
  if (!stu) return;

  stu.individualGroupScoreToday += delta;
  if (stu.individualGroupScoreToday < 0) stu.individualGroupScoreToday = 0;

  saveState();
  renderGroups();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   ğŸŸ¥ çµç®—
   =========================================================== */
function settleGroup(gid) {
  const g = state.groups.find(g => g.id === gid);
  if (!g) return;

  const score = g.memberIds
    .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
    .reduce((a, b) => a + b, 0);

  if (score === 0) {
    alert("çµ„åˆ†ç‚º 0ï¼Œä¸èƒ½çµç®—");
    return;
  }

  g.memberIds.forEach(id => {
    const stu = state.students.find(s => s.id === id);
    stu.totalScore += score;
    stu.individualGroupScoreToday = 0;
  });

  g.groupScore = 0;

  saveState();
  renderGroups();
  renderIndividualPage();
  renderGroupRanking();
  renderDangerZone();
}

/* ===========================================================
   âš ï¸ å±éšªå€ï¼ˆ0 åˆ†ï¼‰
   =========================================================== */
function renderDangerZone() {
  const box = document.getElementById("dangerZone");
  box.innerHTML = "";

  const zero = state.students.filter(s => s.individualGroupScoreToday === 0);

  zero.forEach(stu => {
    const div = document.createElement("div");
    div.textContent = `${stu.seat}. ${stu.name}ï¼ˆ0 åˆ†ï¼‰`;
    box.appendChild(div);
  });
}

/* ===========================================================
   ğŸ† åˆ†çµ„æ’å
   =========================================================== */
function renderGroupRanking() {
  const box = document.getElementById("groupRanking");
  box.innerHTML = "";

  const rank = [...state.groups]
    .map(g => {
      const score = g.memberIds
        .map(id => state.students.find(s => s.id === id)?.individualGroupScoreToday || 0)
        .reduce((a, b) => a + b, 0);
      return { name: g.name, score };
    })
    .sort((a, b) => b.score - a.score);

  rank.forEach((g, i) => {
    const div = document.createElement("div");
    div.textContent = `ç¬¬ ${i + 1} åï¼š${g.name}ï¼ˆ${g.score} åˆ†ï¼‰`;
    box.appendChild(div);
  });
}
</script>
<!-- ========================= -->
<!--  PAGE 2: å°çµ„è¨ˆåˆ†é ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰ -->
<!-- ========================= -->
<div id="page-group" class="page">

  <h2>å°çµ„è¨ˆåˆ†</h2>

  <p style="color:#555;">
    â¤ å·¦é‚Šï¼šæœªåˆ†çµ„å­¸ç”Ÿï¼ˆå¯æ‹–æ›³ï¼‰<br>
    â¤ å³é‚Šï¼šå°çµ„ï¼ˆå¯æ‹–æ›³å­¸ç”Ÿé€²å…¥ï¼‰<br>
    â¤ æ¯å€‹çµ„éƒ½æœ‰ï¼šçµ„å“¡å€‹äºº +/âˆ’ã€è‡ªå‹•çµ„åˆ†ã€çµç®—æŒ‰éˆ•<br>
  </p>

  <div class="group-section">

    <!-- å·¦å´ï¼šæœªåˆ†çµ„å­¸ç”Ÿ -->
    <div class="group-col">
      <h3>æœªåˆ†çµ„å­¸ç”Ÿ</h3>

      <div id="ungroupedList" class="student-list">
        <!-- ç”± JS æ¸²æŸ“ -->
      </div>
    </div>

    <!-- å³å´ï¼šå°çµ„åˆ—è¡¨ -->
    <div class="group-col">
      <h3>å°çµ„åˆ—è¡¨</h3>

      <button class="btn-primary" onclick="addGroup()">
        ï¼‹ æ–°å¢å°çµ„
      </button>

      <div id="groupList" style="margin-top:12px;">
        <!-- JS ç”Ÿæˆçµ„å¡ -->
      </div>
    </div>

  </div>

  <hr style="margin:24px 0;">

  <!-- æ’å & å±éšªå€ -->
  <h3>ğŸ† åˆ†çµ„æ’å</h3>
  <div id="groupRanking"></div>

  <h3 style="margin-top:20px;">âš ï¸ å±éšªå€ï¼ˆä»Šæ—¥ 0 åˆ†ï¼‰</h3>
  <div id="dangerZone"></div>

</div>
<!-- ========================= -->
<!--  PAGE 3: ä½œæ¥­è¨‚æ­£é ï¼ˆå®Œæ•´æ¡†æ¶ï¼‰ -->
<!-- ========================= -->
<div id="page-homework" class="page">

  <h2>ä½œæ¥­è¨‚æ­£</h2>

  <p style="color:#555;">
    â¤ ä¸‹ç‰ˆæœ¬ Step 3 æœƒåŠ å…¥ï¼šæ–°å¢åŠŸèª²ã€å­¸ç”Ÿç‹€æ…‹åˆ‡æ›ã€æº–æ™‚äº¤ +1ã€éæ¿¾å™¨åŠŸèƒ½<br>
    â¤ ä»¥ä¸‹æ˜¯å·²æº–å‚™å¥½çš„æ¡†æ¶ï¼ˆå¯æ­£å¸¸é¡¯ç¤ºï¼‰
  </p>

  <!-- æ–°å¢åŠŸèª² -->
  <div style="margin-bottom:12px;">
    <input id="newHomeworkTitle" type="text" placeholder="è¼¸å…¥åŠŸèª²åç¨±">
    <button class="btn-primary" onclick="alert('Step 3 æ‰æœƒåŠ å…¥å®Œæ•´ä½œæ¥­é‚è¼¯')">
      ï¼‹ æ–°å¢åŠŸèª²
    </button>
  </div>

  <!-- ä½œæ¥­åˆ—è¡¨ -->
  <div id="homeworkList">
    <!-- Step 3 æœƒç”± JS è‡ªå‹•æ¸²æŸ“åŠŸèª²å¡ -->
    <div class="hw-card" style="color:#777;">
      ï¼ˆStep 3 æœƒå•Ÿå‹•ä½œæ¥­é å®Œæ•´åŠŸèƒ½ï¼‰
    </div>
  </div>

</div>
<!-- ========================= -->
<!--  NEW STUDENT SECTION      -->
<!-- ========================= -->

<hr style="margin:30px 0;">

<h2>æ–°å¢å­¸ç”Ÿ</h2>

<div class="card">
  <div style="display:flex; gap:12px; align-items:center;">
    <input id="newSeat" type="number" placeholder="åº§è™Ÿ" style="width:90px;">
    <input id="newName" type="text" placeholder="å§“å">
    <button class="btn-primary" onclick="addStudent()">æ–°å¢</button>
  </div>
</div>

</div> <!-- container END -->

</body>
</html>
